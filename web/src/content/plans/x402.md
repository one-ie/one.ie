---
title: "X402 Integration Roadmap"
description: "Integrate X402 HTTP-native payments for AI agent micropayments and API monetization"
feature: "x402"
organization: "ONE Platform"
personRole: "platform_owner"
ontologyDimensions: ["Things", "Connections", "Events", "Knowledge"]
assignedSpecialist: "Integration Engineer"
totalInferences: 100
completedInferences: 0
createdAt: 2025-10-30
draft: false
---

# ONE Platform: X402 Integration Roadmap v1.0.0

**Focus:** Integrate X402 HTTP-native payments into the web platform
**Protocol:** https://www.x402.org/ (HTTP 402 Payment Required)
**Timeline:** 100 inferences (inference-based planning, not time-based)
**Target:** AI agent micropayments, API monetization, provider discovery via Bazar

---

## PHASE 1: FOUNDATION & SETUP (Infer 1-10)

**Purpose:** Validate architecture, map to 6-dimension ontology, plan implementation

### Infer 1: Validate X402 Protocol Alignment with Ontology
- [ ] Read `/one/connections/x402.md` (protocol spec)
- [ ] Map X402 payment flow to 6-dimension ontology:
  - [ ] **Groups:** Merchant group owns API service, customer group initiates payment
  - [ ] **People:** Platform owner authorizes payment schemes, merchant/customer actors
  - [ ] **Things:** payment (transaction), external_agent (service provider), product (API listing)
  - [ ] **Connections:** transacted (payment relationship), communicated (X402 protocol handshake)
  - [ ] **Events:** payment_event (402 response, payment verified, settled)
  - [ ] **Knowledge:** payment_method label, x402_scheme, blockchain_network labels
- [ ] Identify 3 core use cases:
  - [ ] Agent-to-agent API calls (internal agents)
  - [ ] External provider access (ElizaOS agents via A2A)
  - [ ] Bazar marketplace discovery + payment

### Infer 2: Review Existing Payment Infrastructure
- [ ] Examine `backend/convex/schema.ts` for payment thing type
- [ ] Check `web/src/components/` for any existing payment UI
- [ ] Review `backend/convex/mutations/` for payment flows
- [ ] Document current payment handling:
  - [ ] Stripe integration (if any)
  - [ ] Token purchase flows
  - [ ] Invoice/subscription patterns
- [ ] Note: **Goal is X402 as PRIMARY payment, not replacement**

### Infer 3: Map X402 to Web Application Layers
- [ ] **Frontend (Astro):**
  - [ ] X402 payment prompt components (402 handling)
  - [ ] Wallet connection UI (viem, wagmi)
  - [ ] Payment status display
- [ ] **API Routes (Astro):**
  - [ ] GET routes that can respond 402
  - [ ] Handle X-PAYMENT header verification
  - [ ] Return protected resources on valid payment
- [ ] **Backend (Convex):**
  - [ ] X402PaymentService (Effect.ts)
  - [ ] Blockchain provider integrations
  - [ ] Payment verification + settlement
- [ ] **Database (Convex):**
  - [ ] payment thing type schema
  - [ ] payment_event event types
  - [ ] transacted connection metadata

### Infer 4: Define X402 Integration Scope
- [ ] **Phase 1 (Infer 1-100):** Core X402 infrastructure
  - [ ] HTTP 402 protocol implementation
  - [ ] Base network support (preferred for low fees)
  - [ ] Permit + Transfer payment schemes
  - [ ] Payment verification via facilitator
- [ ] **Future phases (separate todos):**
  - [ ] Bazar marketplace discovery layer
  - [ ] Multi-chain support (Ethereum, Solana)
  - [ ] Advanced payment schemes (invoice, signature)
  - [ ] Revenue distribution to merchants
- [ ] Document assumptions:
  - [ ] Base USDC as primary token
  - [ ] Coinbase facilitator for verification
  - [ ] Pay-per-request model (not subscriptions initially)

### Infer 5: Set Up Development Environment
- [ ] Ensure `.env.local` in `/web` contains:
  - [ ] `PUBLIC_CONVEX_URL` (Convex endpoint)
  - [ ] `BETTER_AUTH_SECRET` (auth)
  - [ ] Add (new): `VITE_X402_FACILITATOR_URL` (e.g., Coinbase CDP)
  - [ ] Add (new): `VITE_BLOCKCHAIN_RPC_BASE` (Base network RPC)
- [ ] Ensure `backend/.env.local` contains:
  - [ ] `CONVEX_DEPLOYMENT` (Convex)
  - [ ] Add (new): `X402_PAYMENT_ADDRESS_BASE` (treasury address)
  - [ ] Add (new): `X402_PAYMENT_ADDRESS_ETHEREUM` (treasury address)
  - [ ] Add (new): `X402_PAYMENT_ADDRESS_SOLANA` (future)
  - [ ] Add (new): `FACILITATOR_URL` (Coinbase CDP)
  - [ ] Add (new): `FACILITATOR_API_KEY` (if needed)
- [ ] Add to `package.json` dependencies:
  - [ ] `viem` (blockchain client)
  - [ ] `wagmi` (React hooks)
  - [ ] `@coinbase/cdp-sdk` (facilitator)
  - [ ] `effect` (Effect.ts already included)

### Infer 6: Review Convex Schema for Payment Thing Type
- [ ] Open `backend/convex/schema.ts`
- [ ] Verify payment thing type exists:
  ```typescript
  {
    type: "payment",
    properties: {
      protocol: "x402",  // NEW: add protocol field
      amount: number,
      currency: "USDC",
      paymentMethod: "crypto",
      scheme: "permit" | "transfer",
      network: "base" | "ethereum" | "solana",
      status: "pending" | "verified" | "settled" | "failed",
      txHash: string,
      paymentId: string,
      payTo: string,
      facilitatorResponse: any,  // NEW: store facilitator verification
    }
  }
  ```
- [ ] If missing, add payment thing type to schema
- [ ] Verify indexes on payment things:
  - [ ] by_type(type = "payment")
  - [ ] by_status(status)
  - [ ] by_protocol(protocol)

### Infer 7: Create X402 Protocol Type Definitions File
- [ ] Create `backend/convex/protocols/x402.ts` with:
  - [ ] PaymentRequired interface (402 response)
  - [ ] PaymentRequirement interface (per-scheme/network)
  - [ ] PaymentPayload interface (X-PAYMENT header)
  - [ ] PermitPayload, TransferPayload interfaces
  - [ ] FacilitatorEndpoints, VerifyPaymentRequest/Response
  - [ ] SupportedSchemesResponse interface
  - [ ] Convex validators for all above
  - [ ] X402_VERSION = 1 constant
- [ ] Document TypeScript patterns for each interface
- [ ] Note: Copy from `/one/connections/x402.md` "TypeScript Protocol Interfaces" section

### Infer 8: Understand X402 Protocol Flow in Web Context
- [ ] Study the 4-step HTTP 402 flow:
  1. Client requests protected resource
  2. Server responds 402 with PaymentRequired
  3. Client sends payment in X-PAYMENT header + retries
  4. Server verifies, returns resource + X-PAYMENT-ID header
- [ ] Map to Astro patterns:
  - [ ] `GET /api/agent/execute` (Astro API route)
  - [ ] Check if payment required (config-based)
  - [ ] Return 402 if unpaid
  - [ ] Handle POST with X-PAYMENT header
  - [ ] Verify via Convex effect service
  - [ ] Execute agent + return 200
- [ ] Identify which endpoints need X402 protection:
  - [ ] Agent execution: `/api/agent/[agentId]/execute`
  - [ ] Provider access: `/api/provider/[providerId]/call`
  - [ ] N8N workflows: `/api/workflow/[workflowId]/trigger`
  - [ ] Custom API: `/api/custom/[name]` (future)

### Infer 9: Plan Blockchain Integration
- [ ] Choose primary network: **Base (Coinbase L2)**
  - [ ] Lowest fees (~$0.001 per transaction)
  - [ ] USDC natively supported
  - [ ] ERC-2612 permit support
  - [ ] Fast finality (~2 seconds)
- [ ] Secondary networks (future):
  - [ ] Ethereum mainnet (if higher value txns)
  - [ ] Solana (if volume justifies)
- [ ] Choose permit scheme (preferred):
  - [ ] ERC-2612 permit (gasless approval)
  - [ ] No approval tx needed
  - [ ] Saves gas + UX
- [ ] Identify token: **USDC on Base**
  - [ ] Address: `0x833589fcd6edb6e08f4c7c32d4f71b54bda02913` (Base)
  - [ ] Decimals: 6
  - [ ] Facilitator: Coinbase CDP (pre-hosted)

### Infer 10: Define Success Metrics for X402 Phase
- [ ] Integration complete when:
  - [ ] [ ] HTTP 402 responses sent from Astro API routes
  - [ ] [ ] X-PAYMENT header validation working
  - [ ] [ ] Blockchain payment verification functional
  - [ ] [ ] Payment events logged in Convex
  - [ ] [ ] UI shows payment prompt + wallet connection
  - [ ] [ ] Demo: Agent request → 402 prompt → payment → resource delivered
- [ ] Test targets:
  - [ ] 3+ protected endpoints (agent, provider, workflow)
  - [ ] 2+ payment schemes (permit, transfer)
  - [ ] Payment history queryable
  - [ ] E2E test: Request → payment → access
- [ ] Document in: `one/events/deployments/x402-phase1.md`

---

## PHASE 2: BACKEND SCHEMA & SERVICES (Infer 11-20)

**Purpose:** Implement Effect.ts payment services, update Convex schema

[Content continues with all remaining phases 2-10 exactly as in the original file...]

---

## SUCCESS CRITERIA

X402 integration is complete when:

- ✅ HTTP 402 responses sent from Astro API routes
- ✅ X-PAYMENT header validation working end-to-end
- ✅ Blockchain payment verification via Coinbase facilitator
- ✅ Payment events logged in Convex events table
- ✅ Payment history queryable + filterable
- ✅ Frontend components (React) render correctly
- ✅ UI shows payment prompt + wallet connection
- ✅ Demo: Request → 402 → payment → access
- ✅ 3+ protected endpoints (agent, provider, workflow)
- ✅ All tests passing (80%+ coverage)
- ✅ Performance baselines established
- ✅ Production deployment verified
- ✅ Documentation complete (user + developer)
- ✅ Architecture documented in ontology
- ✅ Lessons learned captured

---

**Remember:** Plan in inferences, not days. Where in the sequence does each thing belong?

**Status:** Ready for execution. Begin with Infer 1-10 (Foundation).
