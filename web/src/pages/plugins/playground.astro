---
import Layout from "../../layouts/Layout.astro";
import { Button } from "../../components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "../../components/ui/card";

const title = "Plugin Playground | ONE Platform";
const description = "Test and debug plugins in a sandboxed environment";
---

<Layout title={title} description={description}>
  <div class="container mx-auto py-8 px-4">
    {/* Header */}
    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-2">Plugin Playground</h1>
      <p class="text-lg text-muted-foreground">
        Test and debug plugins in a sandboxed environment
      </p>
    </div>

    {/* Main Content */}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Left: Plugin Upload & Config */}
      <div class="space-y-6">
        <Card>
          <CardHeader>
            <CardTitle>Upload Plugin</CardTitle>
            <CardDescription>
              Upload your plugin code to test in the playground
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div id="plugin-upload-area" class="border-2 border-dashed rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-colors">
              <svg class="mx-auto h-12 w-12 text-muted-foreground mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <p class="text-sm font-medium mb-1">Click to upload or drag and drop</p>
              <p class="text-xs text-muted-foreground">Plugin directory (zip) or npm package</p>
              <input type="file" id="plugin-file-input" class="hidden" accept=".zip,.tgz" />
            </div>

            <div class="mt-4">
              <label class="text-sm font-medium mb-2 block">Or enter npm package name:</label>
              <div class="flex gap-2">
                <input
                  type="text"
                  id="npm-package-input"
                  placeholder="@your-org/plugin-name"
                  class="flex-1 px-3 py-2 border rounded-md"
                />
                <Button id="load-npm-package">Load</Button>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Configuration</CardTitle>
            <CardDescription>
              Configure plugin settings and secrets
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div id="plugin-config-form" class="space-y-4">
              <p class="text-sm text-muted-foreground">
                Upload a plugin to configure settings
              </p>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Test Scenarios</CardTitle>
            <CardDescription>
              Select or create test scenarios
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div class="space-y-2">
              <select id="scenario-select" class="w-full px-3 py-2 border rounded-md">
                <option value="">Select a scenario...</option>
                <option value="simple-message">Simple Message</option>
                <option value="action-trigger">Action Trigger</option>
                <option value="provider-request">Provider Request</option>
                <option value="evaluator-test">Evaluator Test</option>
                <option value="custom">Custom Scenario</option>
              </select>

              <div id="scenario-config" class="hidden mt-4">
                <label class="text-sm font-medium mb-2 block">Test Message:</label>
                <textarea
                  id="test-message"
                  rows="3"
                  class="w-full px-3 py-2 border rounded-md"
                  placeholder="Enter test message..."
                ></textarea>
              </div>

              <Button id="run-test" class="w-full mt-4" disabled>
                Run Test
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Right: Execution & Results */}
      <div class="space-y-6">
        <Card>
          <CardHeader>
            <CardTitle>Execution Results</CardTitle>
            <CardDescription>
              View plugin execution output and logs
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div id="execution-results" class="bg-black text-green-400 p-4 rounded-md font-mono text-sm h-96 overflow-y-auto">
              <p class="text-gray-500"># Waiting for plugin test...</p>
              <p class="text-gray-500"># Upload a plugin and run a test to see results</p>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Performance Metrics</CardTitle>
            <CardDescription>
              Execution time, memory usage, and other metrics
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div id="performance-metrics" class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium">Execution Time:</span>
                <span class="text-sm text-muted-foreground">-</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium">Memory Used:</span>
                <span class="text-sm text-muted-foreground">-</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium">API Calls:</span>
                <span class="text-sm text-muted-foreground">-</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium">Status:</span>
                <span class="text-sm text-muted-foreground">Not started</span>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Validation Results</CardTitle>
            <CardDescription>
              Security checks and code analysis
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div id="validation-results" class="space-y-2">
              <p class="text-sm text-muted-foreground">
                No validation results yet
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>

    {/* Quick Actions */}
    <div class="mt-8 flex gap-4 justify-end">
      <Button variant="outline" id="clear-playground">
        Clear Playground
      </Button>
      <Button variant="outline" id="export-results">
        Export Results
      </Button>
      <Button id="deploy-to-org">
        Deploy to Organization
      </Button>
    </div>
  </div>

  <script>
    // Plugin playground client-side logic
    let currentPlugin: any = null;

    // File upload handling
    const uploadArea = document.getElementById("plugin-upload-area");
    const fileInput = document.getElementById("plugin-file-input") as HTMLInputElement;

    uploadArea?.addEventListener("click", () => {
      fileInput?.click();
    });

    fileInput?.addEventListener("change", async (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) {
        await loadPlugin(file);
      }
    });

    // NPM package loading
    document.getElementById("load-npm-package")?.addEventListener("click", async () => {
      const input = document.getElementById("npm-package-input") as HTMLInputElement;
      const packageName = input.value.trim();
      if (packageName) {
        await loadNpmPackage(packageName);
      }
    });

    // Scenario selection
    document.getElementById("scenario-select")?.addEventListener("change", (e) => {
      const value = (e.target as HTMLSelectElement).value;
      const scenarioConfig = document.getElementById("scenario-config");

      if (value) {
        scenarioConfig?.classList.remove("hidden");
        loadScenario(value);
      } else {
        scenarioConfig?.classList.add("hidden");
      }
    });

    // Run test
    document.getElementById("run-test")?.addEventListener("click", async () => {
      if (currentPlugin) {
        await runPluginTest();
      }
    });

    // Clear playground
    document.getElementById("clear-playground")?.addEventListener("click", () => {
      currentPlugin = null;
      clearResults();
    });

    // Functions
    async function loadPlugin(file: File) {
      const resultsDiv = document.getElementById("execution-results");
      if (resultsDiv) {
        resultsDiv.innerHTML = `<p class="text-blue-400"># Loading plugin from ${file.name}...</p>`;
      }

      // TODO: Implement actual plugin loading
      setTimeout(() => {
        if (resultsDiv) {
          resultsDiv.innerHTML += `<p class="text-green-400"># Plugin loaded successfully!</p>`;
          resultsDiv.innerHTML += `<p class="text-gray-400"># Name: example-plugin</p>`;
          resultsDiv.innerHTML += `<p class="text-gray-400"># Version: 1.0.0</p>`;
        }

        const runButton = document.getElementById("run-test") as HTMLButtonElement;
        if (runButton) {
          runButton.disabled = false;
        }
      }, 1000);
    }

    async function loadNpmPackage(packageName: string) {
      const resultsDiv = document.getElementById("execution-results");
      if (resultsDiv) {
        resultsDiv.innerHTML = `<p class="text-blue-400"># Loading package ${packageName} from npm...</p>`;
      }

      // TODO: Implement npm package loading
      setTimeout(() => {
        if (resultsDiv) {
          resultsDiv.innerHTML += `<p class="text-green-400"># Package loaded successfully!</p>`;
        }
      }, 1500);
    }

    function loadScenario(scenario: string) {
      const messageInput = document.getElementById("test-message") as HTMLTextAreaElement;
      if (!messageInput) return;

      const scenarios = {
        "simple-message": "Hello, how are you?",
        "action-trigger": "Send 5 SOL to abc123",
        "provider-request": "What's the weather in San Francisco?",
        "evaluator-test": "This is a great day!",
        "custom": ""
      };

      messageInput.value = scenarios[scenario as keyof typeof scenarios] || "";
    }

    async function runPluginTest() {
      const resultsDiv = document.getElementById("execution-results");
      const metricsDiv = document.getElementById("performance-metrics");
      const messageInput = document.getElementById("test-message") as HTMLTextAreaElement;

      if (!resultsDiv || !metricsDiv) return;

      const testMessage = messageInput.value || "Test message";

      resultsDiv.innerHTML = `<p class="text-blue-400"># Running plugin test...</p>`;
      resultsDiv.innerHTML += `<p class="text-gray-400"># Input: "${testMessage}"</p>`;
      resultsDiv.innerHTML += `<p class="text-gray-400"># Executing in sandboxed environment...</p>`;

      // TODO: Implement actual plugin execution
      setTimeout(() => {
        resultsDiv.innerHTML += `<p class="text-green-400"># Plugin executed successfully!</p>`;
        resultsDiv.innerHTML += `<p class="text-white"># Output: "Response from plugin"</p>`;

        // Update metrics
        metricsDiv.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium">Execution Time:</span>
            <span class="text-sm text-green-600">1.23s</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium">Memory Used:</span>
            <span class="text-sm text-green-600">45 MB</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium">API Calls:</span>
            <span class="text-sm text-green-600">2</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium">Status:</span>
            <span class="text-sm text-green-600 font-semibold">âœ“ Success</span>
          </div>
        `;
      }, 2000);
    }

    function clearResults() {
      const resultsDiv = document.getElementById("execution-results");
      const metricsDiv = document.getElementById("performance-metrics");
      const validationDiv = document.getElementById("validation-results");

      if (resultsDiv) {
        resultsDiv.innerHTML = `
          <p class="text-gray-500"># Waiting for plugin test...</p>
          <p class="text-gray-500"># Upload a plugin and run a test to see results</p>
        `;
      }

      if (metricsDiv) {
        metricsDiv.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium">Execution Time:</span>
            <span class="text-sm text-muted-foreground">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium">Memory Used:</span>
            <span class="text-sm text-muted-foreground">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium">API Calls:</span>
            <span class="text-sm text-muted-foreground">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium">Status:</span>
            <span class="text-sm text-muted-foreground">Not started</span>
          </div>
        `;
      }

      const runButton = document.getElementById("run-test") as HTMLButtonElement;
      if (runButton) {
        runButton.disabled = true;
      }
    }
  </script>
</Layout>
