---
/**
 * Product Details Page Template
 * Features: Gallery, variants, add to cart, reviews, related products
 * Dynamic route: /products/[slug]
 */

import Layout from '@/layouts/Layout.astro';
import { getCollection, getEntry } from 'astro:content';
import { ProductGallery } from '@/components/ecommerce/interactive/ProductGallery';
import { VariantSelector } from '@/components/ecommerce/interactive/VariantSelector';
import { AddToCartButton } from '@/components/ecommerce/interactive/AddToCartButton';
import { QuantitySelector } from '@/components/ecommerce/interactive/QuantitySelector';
import { PriceDisplay } from '@/components/ecommerce/static/PriceDisplay';
import { ReviewStars } from '@/components/ecommerce/static/ReviewStars';
import { Breadcrumbs, type BreadcrumbItem } from '@/components/ecommerce/static/Breadcrumbs';
import { WishlistButton } from '@/components/ecommerce/interactive/Wishlist';
import RecommendationsCarousel from '@/components/ecommerce/static/RecommendationsCarousel';
import { ProductFAQ } from '@/components/ecommerce/static/FAQAccordion';

// Generate static paths for all products
export async function getStaticPaths() {
  const products = await getCollection('products');
  return products.map(product => ({
    params: { slug: product.slug },
  }));
}

const { slug } = Astro.params;

// Get product from content collection
const productEntry = await getEntry('products', slug!);

if (!productEntry) {
  return Astro.redirect('/404');
}

const productData = productEntry.data;

// Adapt content collection data to component format
const product = {
  id: productEntry.id,
  slug: productEntry.slug,
  name: productData.name,
  description: productData.description,
  price: productData.price,
  compareAtPrice: productData.compareAtPrice,
  images: productData.images,
  thumbnail: productData.images[0],
  category: productData.category,
  tags: productData.tags || [],
  inStock: productData.inStock,
  inventory: productData.variants?.reduce((sum, v) => sum + (v.inStock ? 1 : 0), 0) || 0,
  rating: 4.5, // Mock rating - could be added to schema
  reviewCount: 0, // Mock review count - could be added to schema
  featured: productData.featured,
  createdAt: new Date(),
  updatedAt: new Date(),
  variants: productData.variants?.length ? [
    {
      id: 'variant',
      name: 'Options',
      type: 'custom' as const,
      options: productData.variants.map(v => ({
        value: v.id,
        label: v.name,
        inStock: v.inStock,
      })),
    },
  ] : [],
};

// Get related products from same category
const allProducts = await getCollection('products');
const relatedProducts = allProducts
  .filter(p => p.slug !== slug && p.data.category === productData.category)
  .slice(0, 4)
  .map(p => ({
    id: p.id,
    slug: p.slug,
    name: p.data.name,
    description: p.data.description,
    price: p.data.price,
    compareAtPrice: p.data.compareAtPrice,
    thumbnail: p.data.images[0],
    images: p.data.images,
    category: p.data.category,
    tags: p.data.tags || [],
    inStock: p.data.inStock,
    inventory: p.data.variants?.reduce((sum, v) => sum + (v.inStock ? 1 : 0), 0) || 0,
    rating: 4.5,
    reviewCount: 0,
    featured: p.data.featured,
    createdAt: new Date(),
    updatedAt: new Date(),
  }));

const breadcrumbs: BreadcrumbItem[] = [
  { label: 'Shop', href: '/shop' },
  { label: productData.category.charAt(0).toUpperCase() + productData.category.slice(1), href: `/products/?category=${productData.category}` },
  { label: product.name },
];
---

<Layout title={`${product.name} - ONE Store`} description={product.description} sidebarInitialCollapsed>
  <div class="min-h-screen bg-background">
    <div class="container mx-auto px-4 py-8">
      <Breadcrumbs items={breadcrumbs} />

      <div class="grid gap-8 lg:grid-cols-2">
        <!-- Product Gallery -->
        <div>
          <ProductGallery client:load images={product.images} productName={product.name} />
        </div>

        <!-- Product Info -->
        <div>
          <div class="flex items-start justify-between gap-4">
            <h1 class="flex-1 text-3xl font-bold text-foreground">{product.name}</h1>
            <WishlistButton client:load productId={product.id} />
          </div>

          <div class="mt-4">
            <ReviewStars rating={product.rating} reviewCount={product.reviewCount} />
          </div>

          <div class="mt-4">
            <PriceDisplay price={product.price} compareAtPrice={product.compareAtPrice} size="lg" />
          </div>

          <p class="mt-6 text-muted-foreground">{product.description}</p>

          <!-- Variants -->
          {product.variants && product.variants.length > 0 && (
            <div class="mt-8">
              <VariantSelector client:load variants={product.variants} />
            </div>
          )}

          <!-- Quantity -->
          <div class="mt-6">
            <label class="mb-2 block text-sm font-medium text-foreground">Quantity</label>
            <QuantitySelector client:load initialQuantity={1} max={product.inventory} />
          </div>

          <!-- Add to Cart -->
          <div class="mt-8">
            <AddToCartButton
              client:load
              product={{
                id: product.id,
                name: product.name,
                slug: product.slug,
                price: product.price,
                image: product.thumbnail,
              }}
              size="lg"
              className="w-full"
            />
          </div>

          <!-- Stock Status -->
          <div class="mt-4">
            {product.inStock ? (
              <p class="text-sm text-green-600">
                âœ“ In stock ({product.inventory} available)
              </p>
            ) : (
              <p class="text-sm text-destructive">Out of stock</p>
            )}
          </div>

          <!-- Features -->
          <div class="mt-8 space-y-3 border-t border-border pt-6">
            <div class="flex items-center gap-3 text-sm">
              <svg class="h-5 w-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              <span class="text-muted-foreground">Free shipping on orders over $50</span>
            </div>
            <div class="flex items-center gap-3 text-sm">
              <svg class="h-5 w-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              <span class="text-muted-foreground">30-day returns</span>
            </div>
            <div class="flex items-center gap-3 text-sm">
              <svg class="h-5 w-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              <span class="text-muted-foreground">1-year warranty</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Details Tabs -->
      <div class="mt-16">
        <div class="border-b border-border">
          <nav class="-mb-px flex gap-8">
            <button class="border-b-2 border-primary px-1 py-4 text-sm font-medium text-primary">
              Description
            </button>
            <button class="border-b-2 border-transparent px-1 py-4 text-sm font-medium text-muted-foreground hover:border-border hover:text-foreground">
              Reviews ({product.reviewCount})
            </button>
            <button class="border-b-2 border-transparent px-1 py-4 text-sm font-medium text-muted-foreground hover:border-border hover:text-foreground">
              Shipping
            </button>
          </nav>
        </div>
        <div class="py-8">
          <div class="prose prose-sm max-w-none dark:prose-invert">
            <p>Detailed product description goes here. This section can include:</p>
            <ul>
              <li>Material composition</li>
              <li>Care instructions</li>
              <li>Sizing information</li>
              <li>Sustainability features</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- FAQ Section -->
      <div class="mt-16">
        <ProductFAQ client:load />
      </div>

      <!-- Related Products Carousel -->
      {relatedProducts.length > 0 && (
        <div class="mt-16">
          <RecommendationsCarousel
            client:load
            products={relatedProducts}
            title="You May Also Like"
            autoplay={true}
            autoplayDelay={5000}
          />
        </div>
      )}
    </div>
  </div>
</Layout>
