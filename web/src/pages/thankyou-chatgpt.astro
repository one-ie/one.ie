---
import Layout from "@/layouts/Layout.astro";
export const prerender = false; // Server-rendered to retrieve Stripe payment intent

import Stripe from "stripe";

const _title = "Order Confirmed - Thank You!";
const _description = "Your ChatGPT purchase has been confirmed";

// Initialize Stripe
const stripe = new Stripe(import.meta.env.STRIPE_SECRET_KEY || "", {
  apiVersion: "2025-09-30.clover",
  typescript: true,
});

// Get payment intent ID from URL
const paymentIntentId = Astro.url.searchParams.get("payment_intent");

let paymentIntent: Stripe.PaymentIntent | null = null;
let _productName = "Chanel Coco Noir Eau de Parfum";
let amount = 12999; // Default amount in cents
let _currency = "USD";
let _customerEmail = "";

if (paymentIntentId) {
  try {
    paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId);
    amount = paymentIntent.amount;
    _currency = paymentIntent.currency.toUpperCase();
    _customerEmail = paymentIntent.metadata.buyer_email || "";
  } catch (error) {
    console.error("Error retrieving payment intent:", error);
    // Fall back to defaults
  }
}

const _totalAmount = (amount / 100).toFixed(2);
---

<Layout title={title} description={description}>
  <div class="container max-w-3xl mx-auto px-4 py-12">
    {/* Success Message */}
    <div class="text-center mb-12">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 dark:bg-green-900 mb-6">
        <Check class="w-8 h-8 text-green-600 dark:text-green-400" />
      </div>
      <h1 class="text-4xl font-bold mb-4">Order Confirmed!</h1>
      <p class="text-xl text-muted-foreground mb-2">Thank you for your purchase!</p>
      <p class="text-muted-foreground">Your order has been confirmed and is being processed.</p>
    </div>

    {/* Order Details Card */}
    <Card class="mb-8">
      <CardHeader>
        <h2 class="text-2xl font-semibold">Order Summary</h2>
      </CardHeader>
      <CardContent>
        <div class="space-y-6">
          {/* Product Info */}
          <div class="flex items-start gap-4 border-b pb-4">
            <Package class="w-12 h-12 text-primary" />
            <div class="flex-1">
              <p class="font-medium text-lg">{productName}</p>
              <p class="text-sm text-muted-foreground mt-1">
                Elegant and mysterious fragrance with notes of grapefruit, rose, and sandalwood
              </p>
              <div class="flex items-center gap-4 mt-3">
                <div class="text-sm">
                  <span class="text-muted-foreground">Quantity:</span>
                  <span class="font-medium ml-1">1</span>
                </div>
                <div class="text-sm">
                  <span class="text-muted-foreground">Price:</span>
                  <span class="font-medium ml-1">${totalAmount}</span>
                </div>
              </div>
            </div>
          </div>

          {/* Total */}
          <div class="border-t pt-4">
            <div class="flex justify-between items-center">
              <span class="text-lg font-semibold">Total Paid</span>
              <span class="text-2xl font-bold">${totalAmount} {currency}</span>
            </div>
          </div>

          {/* Payment Intent Info */}
          {paymentIntent && (
            <div class="border-t pt-4 text-sm text-muted-foreground">
              <div class="space-y-1">
                <div>Payment ID: {paymentIntent.id}</div>
                <div>Status: <span class="text-green-600 font-medium capitalize">{paymentIntent.status}</span></div>
              </div>
            </div>
          )}

          {/* Confirmation */}
          <div class="border-t pt-4 space-y-3">
            <div class="flex items-start gap-3">
              <Mail class="w-5 h-5 mt-1 text-muted-foreground" />
              <div>
                <p class="font-medium">Confirmation Email</p>
                <p class="text-muted-foreground">
                  {customerEmail ? `Receipt sent to ${customerEmail}` : 'Receipt will be sent to your email shortly'}
                </p>
              </div>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>

    {/* Next Steps */}
    <Card>
      <CardHeader>
        <h2 class="text-2xl font-semibold">What Happens Next?</h2>
      </CardHeader>
      <CardContent>
        <ul class="space-y-4">
          <li class="flex items-start gap-3">
            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center">
              <span class="text-sm font-medium text-primary">1</span>
            </div>
            <div>
              <p class="font-medium">Order Confirmation</p>
              <p class="text-muted-foreground">
                A detailed receipt has been sent to your email. Please check your inbox (and spam folder if needed).
              </p>
            </div>
          </li>
          <li class="flex items-start gap-3">
            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center">
              <span class="text-sm font-medium text-primary">2</span>
            </div>
            <div class="flex items-center gap-2">
              <Truck class="w-5 h-5 text-muted-foreground" />
              <div>
                <p class="font-medium">Free Shipping</p>
                <p class="text-muted-foreground">
                  Your order is being prepared for shipment. Expected delivery: 5-7 business days.
                </p>
              </div>
            </div>
          </li>
          <li class="flex items-start gap-3">
            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center">
              <span class="text-sm font-medium text-primary">3</span>
            </div>
            <div>
              <p class="font-medium">Need Help?</p>
              <p class="text-muted-foreground">
                Questions about your order? Contact our support team at support@one.ie
              </p>
            </div>
          </li>
        </ul>
      </CardContent>
      <CardFooter class="flex gap-4 justify-center">
        <a href="/shop/product-chat" class="inline-flex items-center">
          <Button variant="outline" size="lg">
            Continue Shopping
          </Button>
        </a>
        <a href="/" class="inline-flex items-center">
          <Button variant="default" size="lg" class="gap-2">
            Return Home
            <ArrowRight class="w-4 h-4" />
          </Button>
        </a>
      </CardFooter>
    </Card>
  </div>
</Layout>
