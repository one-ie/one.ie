---
import { FeaturesWithImages } from "@/components/shop/FeaturesWithImages";
import { InlineUrgencyBanner } from "@/components/shop/InlineUrgencyBanner";
import { ProductGallery } from "@/components/shop/interactive/ProductGallery";
import { ProductHeader } from "@/components/shop/ProductHeader";
import { RecentPurchaseToast } from "@/components/shop/RecentPurchaseToast";
import { ReviewsSection } from "@/components/shop/ReviewsSection";
import { StickyBuyBar } from "@/components/shop/StickyBuyBar";
import { StickyCartButton } from "@/components/shop/StickyCartButton";
import { ProductFAQ } from "@/components/shop/static/FAQAccordion";
import { ThemeToggle } from "@/components/shop/ThemeToggle";
import { ValueProposition } from "@/components/shop/ValueProposition";
import ShopLayout from "@/layouts/ShopLayout.astro";

// Check if Stripe is configured
const stripeSecretKey = import.meta.env.STRIPE_SECRET_KEY;
const stripeEnabled = Boolean(stripeSecretKey);

// Import Stripe only if enabled
let stripe: any = null;
if (stripeEnabled) {
	const { default: Stripe } = await import("stripe");
	stripe = new Stripe(stripeSecretKey);
}

// Handle Stripe Checkout Session Creation (POST request)
if (stripeEnabled && Astro.request.method === "POST") {
	try {
		const formData = await Astro.request.formData();
		const quantity = Number(formData.get("quantity")) || 1;
		const customerEmail = formData.get("email")?.toString();

		// Validate quantity
		if (quantity < 1 || quantity > 10) {
			return new Response(JSON.stringify({ error: "Invalid quantity" }), {
				status: 400,
				headers: { "Content-Type": "application/json" },
			});
		}

		// Product info for Stripe
		const productPrice = 899.99;
		const productTitle = "Premium Wireless Headphones Pro";
		const productDescription =
			"Professional-grade wireless headphones with active noise cancellation, premium audio drivers, and 40-hour battery life.";
		const productImage =
			"https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=800&auto=format&fit=crop";

		// Create Stripe Checkout Session
		const session = await stripe.checkout.sessions.create({
			payment_method_types: ["card"],
			line_items: [
				{
					price_data: {
						currency: "usd",
						product_data: {
							name: productTitle,
							description: productDescription,
							images: [productImage],
						},
						unit_amount: Math.round(productPrice * 100),
					},
					quantity: quantity,
				},
			],
			mode: "payment",
			success_url: `${Astro.url.origin}/shop/orders/thank-you-product?session_id={CHECKOUT_SESSION_ID}`,
			cancel_url: `${Astro.url.origin}/electronics`,
			customer_email: customerEmail || undefined,
			metadata: {
				productId: "wireless-headphones-pro",
				productCategory: "Electronics",
			},
		});

		return new Response(JSON.stringify({ url: session.url }), {
			status: 200,
			headers: {
				"Content-Type": "application/json",
			},
		});
	} catch (error) {
		console.error("Stripe checkout error:", error);
		return new Response(
			JSON.stringify({ error: "Payment processing failed" }),
			{
				status: 500,
				headers: { "Content-Type": "application/json" },
			},
		);
	}
}

// Product data
const product = {
	title: "Premium Wireless Headphones Pro",
	category: "Electronics",
	brand: "AudioTech",
	rating: 4.8,
	reviewCount: 247,
	price: 899.99,
	originalPrice: 1299.99,
	stock: 12,
	description:
		"Experience studio-quality sound with our flagship wireless headphones. Featuring advanced active noise cancellation, premium 50mm drivers, and an incredible 40-hour battery life. Perfect for audiophiles, professionals, and music lovers.",
	images: [
		"https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=800&auto=format&fit=crop",
		"https://images.unsplash.com/photo-1484704849700-f032a568e944?w=800&auto=format&fit=crop",
		"https://images.unsplash.com/photo-1545127398-14699f92334b?w=800&auto=format&fit=crop",
	],
};

const specs = [
	{ label: "Brand", value: "AudioTech" },
	{ label: "Type", value: "Over-Ear Wireless" },
	{ label: "Driver Size", value: "50mm Premium Drivers" },
	{ label: "Battery Life", value: "40 hours with ANC" },
	{ label: "Connectivity", value: "Bluetooth 5.3 + AUX" },
	{ label: "Stock Status", value: `${product.stock} units available` },
	{ label: "SKU", value: "AT-WH-PRO-BLK" },
];

const featuresWithImages = [
	{
		title: "Studio-Quality Sound",
		description:
			"Premium 50mm drivers deliver crystal-clear highs, rich mids, and deep bass. Every note, every beat, every detail comes alive. Experience music the way artists intended with our precision-tuned acoustic engineering.",
		image: product.images[0],
	},
	{
		title: "Active Noise Cancellation",
		description:
			"Advanced ANC technology blocks out distractions so you can focus on what matters. Whether you're on a plane, in a busy cafe, or just need peace, enjoy your music without interruption.",
		image: product.images[1],
	},
	{
		title: "All-Day Comfort",
		description:
			"Memory foam ear cushions and an adjustable headband ensure hours of comfortable listening. Premium materials, ergonomic design, and lightweight construction make these headphones perfect for extended wear.",
		image: product.images[2],
	},
];

const reviews = [
	{
		author: "Marcus T.",
		rating: 5,
		text: "Best headphones I've ever owned. The sound quality is phenomenal and the noise cancellation is incredible. Worth every penny!",
		date: "January 2025",
	},
	{
		author: "Sarah K.",
		rating: 5,
		text: "These headphones changed my music experience. Battery lasts forever and they're so comfortable I forget I'm wearing them.",
		date: "December 2024",
	},
	{
		author: "David R.",
		rating: 5,
		text: "As a music producer, I need accurate sound. These deliver. The clarity is exceptional and they're built like a tank.",
		date: "December 2024",
	},
];
---

<ShopLayout title="Premium Wireless Headphones Pro - AudioTech Electronics">
  <div class="bg-white dark:bg-black text-black dark:text-white">
    <!-- Header -->
    <ProductHeader client:load productName={product.title} stripeEnabled={stripeEnabled} />

    <!-- Hero Section - Above the Fold -->
    <section class="max-w-7xl mx-auto px-6 py-24 border-b border-black dark:border-white">
      <div class="grid md:grid-cols-2 gap-20 items-center">
        <!-- Product Gallery - Left Side -->
        <div>
          <ProductGallery client:load images={product.images} productName={product.title} />
        </div>

        <!-- Product Info - Right Side -->
        <div class="space-y-12">
          <!-- Category -->
          <div>
            <p class="text-xs font-bold tracking-[0.3em] uppercase">
              {product.category}
            </p>
          </div>

          <!-- Title -->
          <h1 class="text-5xl md:text-6xl font-light tracking-tight leading-none">
            {product.title}
          </h1>

          <!-- Rating -->
          <div class="flex items-center gap-6 border-t border-b border-black dark:border-white py-4">
            <span class="text-4xl font-light tabular-nums">{product.rating.toFixed(1)}</span>
            <div class="flex gap-1">
              {Array.from({ length: 5 }, (_, i) => (
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" style="color: #D4AF37" opacity={i < Math.floor(product.rating) ? '1' : '0.3'}>
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              ))}
            </div>
            <div class="flex flex-col border-l border-black dark:border-white pl-4">
              <span class="text-[10px] font-bold tracking-[0.25em] uppercase opacity-60">Rating</span>
              <span class="text-[10px] tracking-wide opacity-40">{product.reviewCount} Reviews</span>
            </div>
          </div>

          <!-- Description -->
          <p class="text-base leading-relaxed">
            {product.description}
          </p>

          <!-- Price -->
          <div class="space-y-4">
            <div class="flex items-baseline gap-6">
              <span class="text-6xl font-light tabular-nums">${product.price.toFixed(2)}</span>
              {product.originalPrice && (
                <div class="flex flex-col">
                  <span class="text-sm line-through tabular-nums">
                    ${product.originalPrice.toFixed(2)}
                  </span>
                  <span class="text-xs font-bold tracking-[0.2em] uppercase">
                    Save {Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100)}%
                  </span>
                </div>
              )}
            </div>
          </div>

          <!-- Quantity & Buy Now Button -->
          <div class="space-y-4">
            <div class="flex gap-4">
              <!-- Quantity Selector -->
              <div class="flex items-center border-2 border-black dark:border-white">
                <button
                  id="decrease-qty"
                  class="px-5 py-5 hover:bg-black/5 dark:hover:bg-white/5 transition-colors border-r-2 border-black dark:border-white"
                  aria-label="Decrease quantity"
                >
                  <span class="text-xl font-light">−</span>
                </button>
                <div class="px-6 py-5 min-w-[60px] text-center">
                  <span id="quantity-display" class="text-base font-medium tabular-nums">1</span>
                </div>
                <button
                  id="increase-qty"
                  class="px-5 py-5 hover:bg-black/5 dark:hover:bg-white/5 transition-colors border-l-2 border-black dark:border-white"
                  aria-label="Increase quantity"
                >
                  <span class="text-xl font-light">+</span>
                </button>
              </div>

              <!-- Buy Now Button -->
              <button
                id="hero-buy-button"
                class="flex-1 bg-black dark:bg-white text-white dark:text-black border-2 border-black dark:border-white py-5 hover:opacity-80 transition-opacity duration-200"
              >
                <span class="text-xs font-bold tracking-[0.3em] uppercase">
                  Buy Now
                </span>
              </button>
            </div>
            <div class="grid grid-cols-3 gap-4 text-center text-xs tracking-wide pt-4">
              <div>Free Shipping</div>
              <div>30-Day Returns</div>
              <div>2-Year Warranty</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      // Quantity selector logic
      let currentQuantity = 1;
      const maxQuantity = 10;

      const quantityDisplay = document.getElementById('quantity-display');
      const decreaseBtn = document.getElementById('decrease-qty');
      const increaseBtn = document.getElementById('increase-qty');

      decreaseBtn?.addEventListener('click', () => {
        if (currentQuantity > 1) {
          currentQuantity--;
          if (quantityDisplay) quantityDisplay.textContent = String(currentQuantity);
        }
      });

      increaseBtn?.addEventListener('click', () => {
        if (currentQuantity < maxQuantity) {
          currentQuantity++;
          if (quantityDisplay) quantityDisplay.textContent = String(currentQuantity);
        }
      });

      // Connect hero Buy Now button to header dialog
      const heroBuyButton = document.getElementById('hero-buy-button');
      heroBuyButton?.addEventListener('click', () => {
        (window as any).orderQuantity = currentQuantity;
        window.dispatchEvent(new Event('openBuyDialog'));
      });
    </script>

    <!-- Inline Urgency Banner -->
    <InlineUrgencyBanner
      client:load
      stock={product.stock}
      offerText="Free expedited shipping"
      countdownMinutes={180}
    />

    <!-- Features with Images Section -->
    <FeaturesWithImages features={featuresWithImages} />

    <!-- Product Description + Specs -->
    <section id="details" class="max-w-7xl mx-auto px-6 py-32 border-t-4 border-black dark:border-white">
      <div class="grid md:grid-cols-2 gap-20">
        <div class="space-y-8">
          <div>
            <p class="text-xs font-bold tracking-[0.3em] uppercase mb-6">Description</p>
            <h2 class="text-4xl md:text-5xl font-light leading-tight mb-8">
              Sound perfected
            </h2>
          </div>
          <div class="h-px bg-black dark:bg-white w-20" />
          <p class="text-base leading-relaxed">
            Our Premium Wireless Headphones Pro represent the pinnacle of audio engineering. Every component has been meticulously designed and tested to deliver an unparalleled listening experience.
          </p>
          <p class="text-base leading-relaxed">
            From the custom-tuned 50mm drivers to the advanced noise cancellation algorithm, these headphones are built for those who refuse to compromise on sound quality.
          </p>
        </div>

        <div class="space-y-6">
          <p class="text-xs font-bold tracking-[0.3em] uppercase mb-6">Specifications</p>
          {specs.map(spec => (
            <div class="grid grid-cols-2 gap-6 py-4 border-b border-black dark:border-white">
              <span class="text-xs font-bold tracking-[0.2em] uppercase">{spec.label}</span>
              <span class="text-base">{spec.value}</span>
            </div>
          ))}
        </div>
      </div>
    </section>

    <!-- Value Proposition -->
    <ValueProposition />

    <!-- Reviews -->
    <section id="reviews">
      <ReviewsSection
        averageRating={product.rating}
        totalReviews={product.reviewCount}
        reviews={reviews}
        ratingDistribution={{ 5: 195, 4: 35, 3: 10, 2: 4, 1: 3 }}
      />
    </section>

    <!-- FAQ -->
    <section id="faq" class="max-w-7xl mx-auto px-6">
      <div class="mt-16">
        <ProductFAQ client:load />
      </div>
    </section>

    <!-- Bottom Buy Section -->
    <section class="max-w-7xl mx-auto px-6 py-24">
      <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-16">
          <p class="text-xs font-bold tracking-[0.3em] uppercase mb-4">Final Offer</p>
          <h2 class="text-4xl md:text-5xl font-light tracking-tight">Complete Your Purchase</h2>
        </div>

        <!-- Product Buy Card -->
        <div class="border-2 border-black dark:border-white bg-white dark:bg-black p-6 md:p-8 lg:p-12">
          <div class="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
            <!-- Left: Product Image & Info -->
            <div class="space-y-6">
              <img
                src={product.images[0]}
                alt={product.title}
                class="w-full max-w-[300px] mx-auto aspect-square object-cover border border-black dark:border-white"
              />
              <div class="text-center md:text-left">
                <h3 class="text-2xl font-light tracking-tight mb-3">{product.title}</h3>
                <div class="flex items-baseline gap-4 justify-center md:justify-start mb-4">
                  <span class="text-4xl font-light tabular-nums">${product.price.toFixed(2)}</span>
                  {product.originalPrice && (
                    <div class="flex flex-col">
                      <span class="text-sm line-through tabular-nums opacity-60">
                        ${product.originalPrice.toFixed(2)}
                      </span>
                      <span class="text-xs font-bold tracking-[0.2em] uppercase">
                        Save {Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100)}%
                      </span>
                    </div>
                  )}
                </div>
                <!-- Trust Badges -->
                <div class="grid grid-cols-3 gap-3 text-center text-[10px] tracking-wide border-t border-black dark:border-white pt-4">
                  <div>Free Shipping</div>
                  <div>30-Day Returns</div>
                  <div>2-Year Warranty</div>
                </div>
              </div>
            </div>

            <!-- Right: Quantity & Buy -->
            <div class="space-y-6">
              <!-- Quantity Selector -->
              <div>
                <label class="text-xs font-bold tracking-[0.2em] uppercase mb-3 block">Quantity</label>
                <div class="flex items-center border-2 border-black dark:border-white w-full">
                  <button
                    id="bottom-decrease-qty"
                    class="px-4 md:px-6 py-4 md:py-5 hover:bg-black/5 dark:hover:bg-white/5 transition-colors border-r-2 border-black dark:border-white flex-1"
                    aria-label="Decrease quantity"
                  >
                    <span class="text-xl md:text-2xl font-light">−</span>
                  </button>
                  <div class="px-6 md:px-8 py-4 md:py-5 min-w-[70px] md:min-w-[80px] text-center">
                    <span id="bottom-quantity-display" class="text-xl md:text-2xl font-medium tabular-nums">1</span>
                  </div>
                  <button
                    id="bottom-increase-qty"
                    class="px-4 md:px-6 py-4 md:py-5 hover:bg-black/5 dark:hover:bg-white/5 transition-colors border-l-2 border-black dark:border-white flex-1"
                    aria-label="Increase quantity"
                  >
                    <span class="text-xl md:text-2xl font-light">+</span>
                  </button>
                </div>
              </div>

              <!-- Total -->
              <div class="border-t-2 border-black dark:border-white pt-4 md:pt-6">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-[10px] md:text-xs tracking-[0.2em] uppercase opacity-60">Subtotal</span>
                  <span id="bottom-subtotal" class="text-base md:text-lg font-medium tabular-nums">${product.price.toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center mb-3 md:mb-4">
                  <span class="text-[10px] md:text-xs tracking-[0.2em] uppercase opacity-60">Shipping</span>
                  <span class="text-sm font-bold tracking-wide">FREE</span>
                </div>
                <div class="flex justify-between items-center pt-3 md:pt-4 border-t-2 border-black dark:border-white">
                  <span class="text-xs md:text-sm font-bold tracking-[0.2em] uppercase">Total</span>
                  <span id="bottom-total" class="text-2xl md:text-3xl font-light tabular-nums">${product.price.toFixed(2)}</span>
                </div>
              </div>

              <!-- Buy Now Button -->
              <button
                id="bottom-buy-button"
                class="w-full bg-black dark:bg-white text-white dark:text-black border-2 border-black dark:border-white py-4 md:py-6 hover:opacity-80 transition-opacity duration-200"
              >
                <span class="text-[10px] md:text-xs font-bold tracking-[0.25em] md:tracking-[0.3em] uppercase">
                  Complete Purchase
                </span>
              </button>

              <!-- Additional Info -->
              <p class="text-xs text-center opacity-60 tracking-wide">
                {product.stock} units remaining • Ships within 24 hours
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      // Bottom quantity selector logic
      let bottomQuantity = 1;
      const productPrice = 899.99;

      const bottomQuantityDisplay = document.getElementById('bottom-quantity-display');
      const bottomDecreaseBtn = document.getElementById('bottom-decrease-qty');
      const bottomIncreaseBtn = document.getElementById('bottom-increase-qty');
      const bottomSubtotal = document.getElementById('bottom-subtotal');
      const bottomTotal = document.getElementById('bottom-total');

      function updateBottomTotal() {
        const subtotal = productPrice * bottomQuantity;
        if (bottomSubtotal) bottomSubtotal.textContent = `$${subtotal.toFixed(2)}`;
        if (bottomTotal) bottomTotal.textContent = `$${subtotal.toFixed(2)}`;
      }

      bottomDecreaseBtn?.addEventListener('click', () => {
        if (bottomQuantity > 1) {
          bottomQuantity--;
          if (bottomQuantityDisplay) bottomQuantityDisplay.textContent = String(bottomQuantity);
          updateBottomTotal();
        }
      });

      bottomIncreaseBtn?.addEventListener('click', () => {
        if (bottomQuantity < 10) {
          bottomQuantity++;
          if (bottomQuantityDisplay) bottomQuantityDisplay.textContent = String(bottomQuantity);
          updateBottomTotal();
        }
      });

      const bottomBuyBtn = document.getElementById('bottom-buy-button');
      bottomBuyBtn?.addEventListener('click', () => {
        (window as any).orderQuantity = bottomQuantity;
        window.dispatchEvent(new Event('openBuyDialog'));
      });
    </script>

    <!-- Footer -->
    <footer class="border-t-4 border-black dark:border-white py-16">
      <div class="max-w-7xl mx-auto px-6">
        <div class="grid md:grid-cols-3 gap-8 mb-12">
          <div>
            <p class="text-xs font-bold tracking-[0.3em] uppercase mb-4">
              Shipping
            </p>
            <p class="text-sm leading-relaxed">
              Free worldwide delivery on all orders
            </p>
          </div>
          <div>
            <p class="text-xs font-bold tracking-[0.3em] uppercase mb-4">
              Returns
            </p>
            <p class="text-sm leading-relaxed">
              30-day money-back guarantee
            </p>
          </div>
          <div>
            <p class="text-xs font-bold tracking-[0.3em] uppercase mb-4">
              Warranty
            </p>
            <p class="text-sm leading-relaxed">
              2-year premium coverage
            </p>
          </div>
        </div>
        <div class="border-t border-black dark:border-white pt-8 text-center">
          <p class="text-xs tracking-wide">
            © 2025 AudioTech Electronics. All rights reserved.
          </p>
        </div>
      </div>
    </footer>

    <!-- Sticky Buy Bar (Desktop) -->
    <StickyBuyBar
      client:load
      productName={product.title}
      price={product.price}
      originalPrice={product.originalPrice}
      stripeEnabled={stripeEnabled}
    />

    <!-- Sticky Cart Button (Mobile) -->
    <StickyCartButton client:load price={product.price} productName={product.title} stripeEnabled={stripeEnabled} />

    <!-- Recent Purchase Toast -->
    <RecentPurchaseToast client:load />

    <!-- Theme Toggle -->
    <ThemeToggle client:load />
  </div>
</ShopLayout>
