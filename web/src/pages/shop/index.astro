---
/**
 * Shop Page with Sidebar Filters
 * Browse all products with filtering capabilities
 */

import { getCollection } from "astro:content";
import CollectionPageClient from "@/components/shop/interactive/CollectionPageClient";
import ShopChatLayout from "@/layouts/shop-chat.astro";

// Get all collections and products
const allCollections = await getCollection("collections");
const allProducts = await getCollection("products");

// Transform product helper
const products = allProducts.map((p) => ({
	id: p.id,
	slug: p.slug,
	name: p.data.name,
	description: p.data.description,
	price: p.data.price,
	compareAtPrice: p.data.compareAtPrice,
	images: p.data.images,
	thumbnail: p.data.images[0],
	category: p.data.category,
	tags: p.data.tags || [],
	inStock: p.data.inStock,
	rating: 4.5,
	reviewCount: 0,
	featured: p.data.featured,
	createdAt: new Date(),
	updatedAt: new Date(),
}));

// Collections with associated products (used for filtering)
const collectionCategories = allCollections.map((collection) => ({
	id: collection.slug,
	name: collection.data.name,
	count: collection.data.products?.length || 0,
	products: collection.data.products ?? [],
}));

// Unique tags aggregated from products
const tags = Array.from(
	new Set(allProducts.flatMap((product) => product.data.tags || [])),
);

// Serialize products for client hydration
const productsForClient = products.map((product) => ({
	...product,
	createdAt: product.createdAt.toISOString(),
	updatedAt: product.updatedAt.toISOString(),
}));
---

<ShopChatLayout
  title="Shop - Browse All Products"
  description="Explore all products with AI shopping assistant"
>
  <!-- Main Content -->
  <section class="py-12 md:py-16 bg-background">
    <div class="container mx-auto px-4">
      <CollectionPageClient
        client:load
        products={productsForClient}
        categories={collectionCategories}
        tags={tags}
        currentCollectionSlug="all"
      />
    </div>
  </section>
</ShopChatLayout>
