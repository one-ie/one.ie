---
import { getCollection } from "astro:content";

// Get all news entries, sorted by date (newest first)
const allNewsEntries = await getCollection("news", ({ data }) => {
  return !data.draft; // Filter out drafts
});

// Sort by date descending (newest first)
const _streamEntries = allNewsEntries.sort((a, b) => {
  return b.data.date.valueOf() - a.data.date.valueOf();
});

// Get view mode from URL params, default to list
const viewModeParam = Astro.url.searchParams.get("view") || "list";
const _viewMode = viewModeParam === "list" || viewModeParam === "grid" ? viewModeParam : "list";
const gridColumnsParam = Astro.url.searchParams.get("columns") || "2";
const _gridColumns =
  gridColumnsParam === "2" || gridColumnsParam === "3" || gridColumnsParam === "4"
    ? gridColumnsParam
    : "2";

// Format date helper
function _formatDate(date: Date): string {
  return new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  }).format(date);
}
---

<Layout title="News - Latest Updates | ONE Platform">
  <!-- Hero Section (Compact) -->
  <section class="relative overflow-hidden px-4 py-8 sm:px-6 sm:py-10 md:px-8 md:py-12">
    <div class="absolute inset-0 -z-10">
      <div class="absolute inset-0 bg-gradient-to-b from-background via-primary/5 to-background"></div>
    </div>

    <div class="mx-auto max-w-4xl space-y-3">
      <h1 class="text-4xl font-bold leading-tight tracking-tight sm:text-5xl text-center">
        News
      </h1>

      <!-- Controls Row: Stats + View Toggle -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-center gap-8 pt-8">
        <div class="flex items-center gap-6 text-sm text-muted-foreground">
          <div class="flex items-center gap-2">
            <Activity className="h-4 w-4 text-primary" />
            <span><strong>{streamEntries.length}</strong> updates</span>
          </div>
          <div class="flex items-center gap-2">
            <Clock className="h-4 w-4 text-primary" />
            <span>Updated daily</span>
          </div>
        </div>

        <!-- View Mode Toggle -->
        <div class="flex gap-2 items-center">
          <a
            href="/news?view=list"
            class={`p-3 rounded-md hover:bg-accent hover:scale-110 transition-all duration-200 ${viewMode === 'list' ? 'bg-accent' : ''}`}
            title="List view"
          >
            <List className="w-5 h-5" />
          </a>
          <a
            href="/news?view=grid&columns=2"
            class={`p-3 rounded-md hover:bg-accent hover:scale-110 transition-all duration-200 ${viewMode === 'grid' && gridColumns === '2' ? 'bg-accent' : ''}`}
            title="2 columns grid"
          >
            <Grid className="w-5 h-5" />
          </a>
          <a
            href="/news?view=grid&columns=3"
            class={`p-3 rounded-md hover:bg-accent hover:scale-110 transition-all duration-200 ${viewMode === 'grid' && gridColumns === '3' ? 'bg-accent' : ''}`}
            title="3 columns grid"
          >
            <div class="w-5 h-5 grid grid-cols-3 gap-0.5">
              <div class="bg-current rounded-sm"></div>
              <div class="bg-current rounded-sm"></div>
              <div class="bg-current rounded-sm"></div>
            </div>
          </a>
          <a
            href="/news?view=grid&columns=4"
            class={`p-3 rounded-md hover:bg-accent hover:scale-110 transition-all duration-200 ${viewMode === 'grid' && gridColumns === '4' ? 'bg-accent' : ''}`}
            title="4 columns grid"
          >
            <div class="w-5 h-5 grid grid-cols-2 grid-rows-2 gap-0.5">
              <div class="bg-current rounded-sm"></div>
              <div class="bg-current rounded-sm"></div>
              <div class="bg-current rounded-sm"></div>
              <div class="bg-current rounded-sm"></div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- News Feed with Search -->
  <section class="px-4 py-6 sm:px-6 md:px-8">
    <div class="mx-auto max-w-4xl">
      <!-- Search Component -->
      <StreamSearch
        client:load
        posts={streamEntries}
        viewMode={viewMode as 'list' | 'grid'}
        gridColumns={gridColumns as '2' | '3' | '4'}
      />

      <!-- Empty state (if no entries at all) -->
      {streamEntries.length === 0 && (
        <Card className="border-border/50 bg-card/50 backdrop-blur">
          <CardContent className="py-16 text-center">
            <Activity className="h-12 w-12 mx-auto mb-4 text-muted-foreground/50" />
            <h3 class="text-xl font-semibold mb-2">No updates yet</h3>
            <p class="text-muted-foreground">
              Check back soon for the latest activity on ONE Platform.
            </p>
          </CardContent>
        </Card>
      )}
    </div>
  </section>

  <!-- CTA Section -->
  <section class="border-t px-4 py-16 sm:px-6 sm:py-20 md:px-8 md:py-24">
    <div class="mx-auto max-w-2xl text-center space-y-6">
      <h2 class="text-3xl font-bold">Want to Contribute?</h2>
      <p class="text-lg text-muted-foreground">
        Join the ONE Platform community and see your contributions appear in the stream.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="/download">
          <button class="inline-flex items-center justify-center gap-2 rounded-md bg-primary px-8 py-3 text-sm font-medium text-primary-foreground shadow transition-colors hover:bg-primary/90">
            Download ONE
            <span>→</span>
          </button>
        </a>
        <a href="https://github.com/one-ie" target="_blank" rel="noopener noreferrer">
          <button class="inline-flex items-center justify-center gap-2 rounded-md border border-border px-8 py-3 text-sm font-medium transition-colors hover:bg-muted">
            View on GitHub
            <span>→</span>
          </button>
        </a>
      </div>
    </div>
  </section>
</Layout>
