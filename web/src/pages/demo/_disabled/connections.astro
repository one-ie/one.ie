---
import Layout from '@/layouts/Layout.astro';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { ConnectionsDemo } from '@/components/demo/ConnectionsDemo';
import {
  ArrowRight,
  ArrowDown,
  Link as LinkIcon,
  Code2,
  GitBranch,
  Network,
  Home,
  Bot,
  FileText,
  Users,
  RefreshCw,
  CheckCircle,
  Users2,
  Briefcase,
  Coins,
  Package,
  BarChart3,
  Database,
  Zap,
  Activity,
  Boxes,
} from 'lucide-react';

export const prerender = false;

// Fetch demo data from backend
let demoConnections = [];
let error = null;

try {
  const convexUrl = import.meta.env.PUBLIC_CONVEX_URL || 'https://veracious-marlin-319.convex.cloud';
  const response = await fetch(`${convexUrl}/api/connections?limit=20`);

  if (response.ok) {
    const data = await response.json();
    demoConnections = data.connections || data.data || [];
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to fetch connections';
  console.log('Note: Running in standalone mode - no backend data available');
}

// Relationship types for the connections dimension
const relationshipCategories = [
  {
    title: 'Ownership (2)',
    icon: Home,
    types: [
      { name: 'owns', description: 'A owns B' },
      { name: 'created_by', description: 'A was created by B' }
    ],
    color: 'bg-blue-50 border-blue-200 dark:bg-blue-950 dark:border-blue-900'
  },
  {
    title: 'AI Relationships (3)',
    icon: Bot,
    types: [
      { name: 'clone_of', description: 'AI clone of person' },
      { name: 'trained_on', description: 'AI trained on knowledge' },
      { name: 'powers', description: 'AI powers feature' }
    ],
    color: 'bg-purple-50 border-purple-200 dark:bg-purple-950 dark:border-purple-900'
  },
  {
    title: 'Content (5)',
    icon: FileText,
    types: [
      { name: 'authored', description: 'Person authored content' },
      { name: 'generated_by', description: 'Content generated by AI' },
      { name: 'published_to', description: 'Content published to platform' },
      { name: 'part_of', description: 'Content part of collection' },
      { name: 'references', description: 'Content references other content' }
    ],
    color: 'bg-green-50 border-green-200 dark:bg-green-950 dark:border-green-900'
  },
  {
    title: 'Community (4)',
    icon: Users2,
    types: [
      { name: 'member_of', description: 'Person member of org/community' },
      { name: 'following', description: 'Person follows person' },
      { name: 'moderates', description: 'Person moderates community' },
      { name: 'participated_in', description: 'Person participated in conversation' }
    ],
    color: 'bg-orange-50 border-orange-200 dark:bg-orange-950 dark:border-orange-900'
  },
  {
    title: 'Business (3)',
    icon: Briefcase,
    types: [
      { name: 'manages', description: 'Person manages person/team' },
      { name: 'reports_to', description: 'Person reports to person' },
      { name: 'collaborates_with', description: 'Person collaborates with person' }
    ],
    color: 'bg-yellow-50 border-yellow-200 dark:bg-yellow-950 dark:border-yellow-900'
  },
  {
    title: 'Tokens (3)',
    icon: Coins,
    types: [
      { name: 'holds_tokens', description: 'Person holds tokens' },
      { name: 'staked_in', description: 'Tokens staked in pool' },
      { name: 'earned_from', description: 'Tokens earned from activity' }
    ],
    color: 'bg-red-50 border-red-200 dark:bg-red-950 dark:border-red-900'
  },
  {
    title: 'Products (4)',
    icon: Package,
    types: [
      { name: 'purchased', description: 'Person purchased product' },
      { name: 'enrolled_in', description: 'Person enrolled in course' },
      { name: 'completed', description: 'Person completed course' },
      { name: 'teaching', description: 'AI teaching course' }
    ],
    color: 'bg-cyan-50 border-cyan-200 dark:bg-cyan-950 dark:border-cyan-900'
  },
  {
    title: 'Consolidated (7)',
    icon: RefreshCw,
    types: [
      { name: 'transacted', description: 'Payment/subscription (uses metadata)' },
      { name: 'notified', description: 'Notifications (uses metadata)' },
      { name: 'referred', description: 'Referrals (uses metadata)' },
      { name: 'communicated', description: 'Agent/protocol communication' },
      { name: 'delegated', description: 'Task/workflow delegation' },
      { name: 'approved', description: 'Approvals (uses metadata)' },
      { name: 'fulfilled', description: 'Fulfillment (uses metadata)' }
    ],
    color: 'bg-indigo-50 border-indigo-200 dark:bg-indigo-950 dark:border-indigo-900'
  }
];

const codeExamples = [
  {
    title: 'Ownership Connection',
    description: 'Creator owns AI clone',
    code: `{
  fromThingId: creatorId,
  toThingId: cloneId,
  relationshipType: "owns",
  createdAt: Date.now()
}`
  },
  {
    title: 'Token Holding',
    description: 'User holds tokens with balance metadata',
    code: `{
  fromThingId: userId,
  toThingId: tokenId,
  relationshipType: "holds_tokens",
  metadata: {
    balance: 1000,
    network: "sui",
    acquiredAt: Date.now()
  },
  createdAt: Date.now()
}`
  },
  {
    title: 'Course Enrollment',
    description: 'User enrolled with progress tracking',
    code: `{
  fromThingId: userId,
  toThingId: courseId,
  relationshipType: "enrolled_in",
  metadata: {
    progress: 0.45,      // 45% complete
    enrolledAt: Date.now(),
    lastAccessedAt: Date.now()
  },
  createdAt: Date.now()
}`
  },
  {
    title: 'Organization Membership',
    description: 'User membership with role and permissions',
    code: `{
  fromThingId: userId,
  toThingId: organizationId,
  relationshipType: "member_of",
  metadata: {
    role: "org_owner",
    permissions: ["read", "write", "admin"],
    joinedAt: Date.now()
  },
  createdAt: Date.now()
}`
  },
  {
    title: 'Payment Transaction',
    description: 'Consolidated transacted relationship',
    code: `{
  fromThingId: userId,
  toThingId: productId,
  relationshipType: "transacted",
  metadata: {
    transactionType: "payment",
    amount: 99.00,
    currency: "USD",
    paymentId: "pi_123456",
    status: "completed",
    protocol: "stripe"
  },
  createdAt: Date.now()
}`
  },
  {
    title: 'Agent Communication',
    description: 'Consolidated communicated relationship',
    code: `{
  fromThingId: oneAgentId,
  toThingId: externalAgentId,
  relationshipType: "communicated",
  metadata: {
    protocol: "a2a",
    messageType: "task_delegation",
    task: "research_market_trends",
    messagesExchanged: 42
  },
  createdAt: Date.now()
}`
  }
];
---

<Layout title="Connections - Relationships & Metadata">
  <main class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 py-12">
    <div class="max-w-7xl mx-auto px-4">

      <!-- Hero Section -->
      <div class="mb-16 text-center">
        <h1 class="text-5xl md:text-6xl font-bold text-slate-900 dark:text-white mb-6">
          Connections
        </h1>
        <p class="text-xl text-slate-600 dark:text-slate-400 mb-8 max-w-3xl mx-auto">
          Every relationship between entities - from ownership to collaboration, from payments to AI communication.
          Connections are the edges of your graph.
        </p>
        <div class="inline-flex gap-2 flex-wrap justify-center">
          <span class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 rounded-full text-sm font-medium">
            < LinkIcon className="w-4 h-4" /> 25+ Relationship Types
          </span>
          <span class="inline-flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 rounded-full text-sm font-medium">
            < RefreshCw className="w-4 h-4" /> Bidirectional
          </span>
          <span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 rounded-full text-sm font-medium">
            < BarChart3 className="w-4 h-4" /> Metadata-Rich
          </span>
        </div>
      </div>

      <!-- 6-Dimension Overview -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-3 mb-16">
        <a href="/demo/groups" class="group">
          <div class="bg-white dark:bg-slate-800 rounded-lg shadow hover:shadow-lg transition p-4 text-center">
            "<Users className=""w-8 h-8 mx-auto mb-2 text-slate-600 dark:text-slate-400 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition" />
            <h3 class="font-semibold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400">Groups</h3>
            <p class="text-xs text-slate-600 dark:text-slate-400">Multi-tenant</p>
          </div>
        </a>

        <a href="/demo/people" class="group">
          <div class="bg-white dark:bg-slate-800 rounded-lg shadow hover:shadow-lg transition p-4 text-center">
            "<Users className=""w-8 h-8 mx-auto mb-2 text-slate-600 dark:text-slate-400 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition" />
            <h3 class="font-semibold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400">People</h3>
            <p class="text-xs text-slate-600 dark:text-slate-400">Authorization</p>
          </div>
        </a>

        <a href="/demo/things" class="group">
          <div class="bg-white dark:bg-slate-800 rounded-lg shadow hover:shadow-lg transition p-4 text-center">
            "<Package className=""w-8 h-8 mx-auto mb-2 text-slate-600 dark:text-slate-400 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition" />
            <h3 class="font-semibold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400">Things</h3>
            <p class="text-xs text-slate-600 dark:text-slate-400">Entities</p>
          </div>
        </a>

        <div class="bg-blue-50 dark:bg-blue-950 rounded-lg shadow border-2 border-blue-300 dark:border-blue-700 p-4 text-center">
          < LinkIcon className="w-8 h-8 mx-auto mb-2 text-blue-600 dark:text-blue-400" />
          <h3 class="font-semibold text-blue-900 dark:text-blue-300">Connections</h3>
          <p class="text-xs text-blue-700 dark:text-blue-400">You are here</p>
        </div>

        <a href="/demo/events" class="group">
          <div class="bg-white dark:bg-slate-800 rounded-lg shadow hover:shadow-lg transition p-4 text-center">
            < BarChart3 className="w-8 h-8 mx-auto mb-2 text-slate-600 dark:text-slate-400 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition" />
            <h3 class="font-semibold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400">Events</h3>
            <p class="text-xs text-slate-600 dark:text-slate-400">Audit trail</p>
          </div>
        </a>

        <a href="/demo/search" class="group">
          <div class="bg-white dark:bg-slate-800 rounded-lg shadow hover:shadow-lg transition p-4 text-center">
            < Network className="w-8 h-8 mx-auto mb-2 text-slate-600 dark:text-slate-400 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition" />
            <h3 class="font-semibold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400">Knowledge</h3>
            <p class="text-xs text-slate-600 dark:text-slate-400">Search & RAG</p>
          </div>
        </a>
      </div>

      <!-- What Are Connections -->
      <Card className="mb-16 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
        <CardHeader>
          <div class="flex items-center gap-2">
            <Network className="w-6 h-6 text-blue-600 dark:text-blue-400" />
            <CardTitle>What Are Connections?</CardTitle>
          </div>
        </CardHeader>
        <CardContent className="space-y-4 text-slate-700 dark:text-slate-300">
          <p>
            Connections represent relationships between entities (Things). If you're describing how thing X relates to thing Y, it's a connection.
          </p>
          <div class="grid md:grid-cols-2 gap-6 mt-6">
            <div>
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                < CheckCircle className="w-5 h-5 text-blue-600 dark:text-blue-400" /> Bidirectional
              </h3>
              <p class="text-sm">
                Query relationships from either direction. Find "what owns X" or "what X owns".
              </p>
            </div>
            <div>
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                < CheckCircle className="w-5 h-5 text-blue-600 dark:text-blue-400" /> Metadata-Rich
              </h3>
              <p class="text-sm">
                Store relationship-specific data like balance, progress, permissions, or protocol details.
              </p>
            </div>
            <div>
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                < CheckCircle className="w-5 h-5 text-blue-600 dark:text-blue-400" /> Temporal Validity
              </h3>
              <p class="text-sm">
                Track when relationships start and end with validFrom/validTo timestamps.
              </p>
            </div>
            <div>
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                < CheckCircle className="w-5 h-5 text-blue-600 dark:text-blue-400" /> Protocol-Agnostic
              </h3>
              <p class="text-sm">
                Store protocol identity in metadata.protocol - supports any integration.
              </p>
            </div>
          </div>
        </CardContent>
      </Card>

      <!-- Connection Structure -->
      < Card className="mb-16 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
        <CardHeader>
          <div class="flex items-center gap-2">
            < Code2 className="w-6 h-6 text-green-600 dark:text-green-400" />
            <CardTitle>Connection Structure</CardTitle>
          </div>
        </CardHeader>
        <CardContent>
          <div class="bg-slate-900 dark:bg-slate-950 rounded-lg p-4 overflow-x-auto">
            <code class="text-green-400 dark:text-green-300 text-sm font-mono">
{`{
  _id: Id<"connections">,
  fromThingId: Id<"things">,        // Source entity
  toThingId: Id<"things">,          // Target entity
  relationshipType: ConnectionType, // Type of relationship
  metadata?: {
    // Optional relationship data
    // Examples: balance, progress, permissions, protocol
  },
  strength?: number,    // Relationship strength (0-1)
  validFrom?: number,   // When relationship started
  validTo?: number,     // When relationship ended
  createdAt: number,
  updatedAt?: number
}`}
            </code>
          </div>
        </CardContent>
      </Card>

      <!-- Relationship Types Grid -->
      <div class="mb-16">
        <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-8">25+ Relationship Types</h2>
        <div class="space-y-6">
          {relationshipCategories.map((category) => {
            const Icon = category.icon;
            return (
              <div class={`border rounded-lg p-6 ${category.color}`}>
                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                  < Icon class="w-6 h-6 text-slate-700 dark:text-slate-300" />
                  {category.title}
                </h3>
                <div class="grid md:grid-cols-2 gap-4">
                  {category.types.map((type) => (
                    <div class="bg-white dark:bg-slate-700 rounded p-4 shadow-sm">
                      <div class="flex items-start gap-2">
                        < ArrowRight className="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                        <div>
                          <code class="text-sm font-semibold text-slate-900 dark:text-white bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">
                            {type.name}
                          </code>
                          <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">{type.description}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </div>

      <!-- Bidirectional Relationships -->
      < Card className="mb-16 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
        <CardHeader>
          <div class="flex items-center gap-2">
            < GitBranch className="w-6 h-6 text-purple-600 dark:text-purple-400" />
            <CardTitle>Bidirectional Relationships</CardTitle>
          </div>
        </CardHeader>
        < CardContent className=" class="space-y-6">
          <p class="text-slate-700 dark:text-slate-300">
            Connections can be queried efficiently from either direction using indexes.
          </p>

          <div class="grid md:grid-cols-3 gap-6">
            {/* Ownership Direction */}
            <div class="border border-slate-200 dark:border-slate-600 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">Forward: Who Owns What</h3>
              <div class="text-sm text-slate-600 dark:text-slate-400 space-y-2">
                <div class="bg-slate-50 dark:bg-slate-900 rounded p-3">
                  <p class="font-mono text-xs">fromThingId = userId</p>
                  <p class="font-mono text-xs">relationshipType = "owns"</p>
                </div>
                <div class="flex justify-center">
                  < ArrowDown className="w-5 h-5 text-slate-400 dark:text-slate-600" />
                </div>
                <p class="font-semibold text-blue-600 dark:text-blue-400">All entities user owns</p>
              </div>
            </div>

            {/* Reverse Direction */}
            <div class="border border-slate-200 dark:border-slate-600 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">Reverse: Who Owns This</h3>
              <div class="text-sm text-slate-600 dark:text-slate-400 space-y-2">
                <div class="bg-slate-50 dark:bg-slate-900 rounded p-3">
                  <p class="font-mono text-xs">toThingId = contentId</p>
                  <p class="font-mono text-xs">relationshipType = "owns"</p>
                </div>
                <div class="flex justify-center">
                  < ArrowDown className="w-5 h-5 text-slate-400 dark:text-slate-600" />
                </div>
                <p class="font-semibold text-blue-600 dark:text-blue-400">All owners of content</p>
              </div>
            </div>

            {/* Index Strategy */}
            <div class="border border-slate-200 dark:border-slate-600 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">Index Strategy</h3>
              <div class="text-sm text-slate-600 dark:text-slate-400 space-y-2">
                <p>Two indexes enable both queries:</p>
                <ul class="space-y-1 font-mono text-xs">
                  <li class="text-blue-600 dark:text-blue-400 flex items-center gap-1">< Coins className="w-3 h-3" /> from_type</li>
                  <li class="text-blue-600 dark:text-blue-400 flex items-center gap-1">< Coins className="w-3 h-3" /> to_type</li>
                </ul>
                <p class="mt-3">Both queries run in O(log n)</p>
              </div>
            </div>
          </div>

          <div class="mt-6 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <p class="text-sm text-blue-900 dark:text-blue-300">
              <span class="font-semibold">Key principle:</span> Connections are edges in a graph. You query outgoing edges (from_type) and incoming edges (to_type).
            </p>
          </div>
        </CardContent>
      </Card>

      <!-- Code Examples -->
      <div class="mb-16">
        <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-8">Connection Examples</h2>
        <div class="grid lg:grid-cols-2 gap-6">
          {codeExamples.map((example) => (
            < Card className="bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700">
              <CardHeader>
                < CardTitle className="text-lg">{example.title}</CardTitle>
                <CardDescription>{example.description}</CardDescription>
              </CardHeader>
              <CardContent>
                <div class="bg-slate-900 dark:bg-slate-950 rounded-lg p-4 overflow-x-auto">
                  <code class="text-green-400 dark:text-green-300 text-xs font-mono">
                    {example.code}
                  </code>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      </div>

      <!-- Temporal Validity -->
      < Card className="mb-16 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
        <CardHeader>
          <div class="flex items-center gap-2">
            < Zap className="w-6 h-6 text-yellow-600 dark:text-yellow-400" />
            <CardTitle>Temporal Validity: When Relationships Matter</CardTitle>
          </div>
        </CardHeader>
        < CardContent className=" class="space-y-6">
          <p class="text-slate-700 dark:text-slate-300">
            Track the lifespan of relationships with validFrom and validTo timestamps.
          </p>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">Employment Relationship</h3>
              <code class="text-xs font-mono text-slate-700 dark:text-slate-300">
{`{
  fromThingId: personId,
  toThingId: companyId,
  relationshipType: "works_for",
  validFrom: 1704067200000, // Jan 1, 2024
  validTo: 1735689600000,   // Dec 31, 2024
  metadata: {
    role: "Engineer",
    salary: 150000
  }
}`}
              </code>
            </div>

            <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">Query Active Relationships</h3>
              <code class="text-xs font-mono text-slate-700 dark:text-slate-300">
{`// Get people currently employed
const active = connections
  .filter(c => !c.validTo ||
    c.validTo > Date.now())
  .filter(c => !c.validFrom ||
    c.validFrom <= Date.now())

// Get relationship history
const history = connections
  .filter(c => c.validTo)
  .sort((a, b) =>
    b.validTo - a.validTo)`}
              </code>
            </div>
          </div>

          <div class="bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg p-4">
            <p class="text-sm text-amber-900 dark:text-amber-300">
              <span class="font-semibold">Use validTo for:</span> Contract end dates, subscription cancellations, project completions, employment termination, relationship history tracking.
            </p>
          </div>
        </CardContent>
      </Card>

      <!-- API Examples -->
      < Card className="mb-16 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
        <CardHeader>
          <div class="flex items-center gap-2">
            < Code2 className="w-6 h-6 text-red-600 dark:text-red-400" />
            <CardTitle>REST API Examples</CardTitle>
          </div>
        </CardHeader>
        < CardContent className=" class="space-y-6">
          <div class="space-y-4">
            <div class="border border-slate-200 dark:border-slate-600 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3 font-mono">GET /api/connections</h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">List all connections with filtering</p>
              <div class="bg-slate-900 dark:bg-slate-950 rounded p-3 overflow-x-auto">
                <code class="text-green-400 dark:text-green-300 text-xs font-mono">
{`curl "https://api.example.com/api/connections?relationshipType=owns&limit=10"`}
                </code>
              </div>
            </div>

            <div class="border border-slate-200 dark:border-slate-600 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3 font-mono">GET /api/connections/[id]</h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">Get specific connection</p>
              <div class="bg-slate-900 dark:bg-slate-950 rounded p-3 overflow-x-auto">
                <code class="text-green-400 dark:text-green-300 text-xs font-mono">
{`curl "https://api.example.com/api/connections/conn_123"`}
                </code>
              </div>
            </div>

            <div class="border border-slate-200 dark:border-slate-600 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3 font-mono">POST /api/connections</h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">Create new connection</p>
              <div class="bg-slate-900 dark:bg-slate-950 rounded p-3 overflow-x-auto">
                <code class="text-green-400 dark:text-green-300 text-xs font-mono">
{`curl -X POST "https://api.example.com/api/connections" \\
  -H "Content-Type: application/json" \\
  -d '{
    "fromThingId": "thing_123",
    "toThingId": "thing_456",
    "relationshipType": "owns",
    "metadata": {
      "createdBy": "user_789"
    }
  }'`}
                </code>
              </div>
            </div>

            <div class="border border-slate-200 dark:border-slate-600 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3 font-mono">GET /api/connections/from/[thingId]</h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">Get all outgoing connections (what this owns)</p>
              <div class="bg-slate-900 dark:bg-slate-950 rounded p-3 overflow-x-auto">
                <code class="text-green-400 dark:text-green-300 text-xs font-mono">
{`curl "https://api.example.com/api/connections/from/user_123?relationshipType=owns"`}
                </code>
              </div>
            </div>

            <div class="border border-slate-200 dark:border-slate-600 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3 font-mono">GET /api/connections/to/[thingId]</h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">Get all incoming connections (who owns this)</p>
              <div class="bg-slate-900 dark:bg-slate-950 rounded p-3 overflow-x-auto">
                <code class="text-green-400 dark:text-green-300 text-xs font-mono">
{`curl "https://api.example.com/api/connections/to/content_789?relationshipType=owns"`}
                </code>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      <!-- TypeScript Types -->
      < Card className="mb-16 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
        <CardHeader>
          <div class="flex items-center gap-2">
            < Code2 className="w-6 h-6 text-blue-600 dark:text-blue-400" />
            <CardTitle>TypeScript Types</CardTitle>
          </div>
        </CardHeader>
        <CardContent>
          <div class="bg-slate-900 dark:bg-slate-950 rounded-lg p-4 overflow-x-auto">
            <code class="text-green-400 dark:text-green-300 text-sm font-mono">
{`// Core connection type
type Connection = {
  _id: Id<"connections">,
  fromThingId: Id<"things">,
  toThingId: Id<"things">,
  relationshipType: ConnectionType,
  metadata?: Record<string, any>,
  strength?: number,
  validFrom?: number,
  validTo?: number,
  createdAt: number,
  updatedAt?: number
}

// All relationship types
type ConnectionType =
  | "owns" | "created_by"
  | "clone_of" | "trained_on" | "powers"
  | "authored" | "generated_by" | "published_to"
  | "part_of" | "references"
  | "member_of" | "following" | "moderates"
  | "participated_in"
  | "manages" | "reports_to" | "collaborates_with"
  | "holds_tokens" | "staked_in" | "earned_from"
  | "purchased" | "enrolled_in" | "completed"
  | "teaching"
  | "transacted" | "notified" | "referred"
  | "communicated" | "delegated" | "approved"
  | "fulfilled"

// Query result
type ConnectionQuery = {
  connection: Connection,
  fromThing?: Thing,
  toThing?: Thing
}`}
            </code>
          </div>
        </CardContent>
      </Card>

      <!-- Finding Related Items -->
      < Card className="mb-16 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
        <CardHeader>
          <div class="flex items-center gap-2">
            < LinkIcon className="w-6 h-6 text-cyan-600 dark:text-cyan-400" />
            <CardTitle>Finding Related Items</CardTitle>
          </div>
        </CardHeader>
        < CardContent className=" class="space-y-6">
          <p class="text-slate-700 dark:text-slate-300">
            Common patterns for discovering connections and related entities.
          </p>

          <div class="grid lg:grid-cols-3 gap-6">
            <!-- Pattern 1 -->
            <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">What does user own?</h3>
              <code class="text-xs font-mono text-slate-700 dark:text-slate-300">
{`const owned = await db
  .query("connections")
  .withIndex("from_type", q =>
    q.eq("fromThingId", userId)
     .eq("relationshipType",
       "owns")
  )
  .collect();

const ownedThings =
  await Promise.all(
    owned.map(c =>
      db.get(c.toThingId)
    )
  );`}
              </code>
            </div>

            <!-- Pattern 2 -->
            <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">Who owns content?</h3>
              <code class="text-xs font-mono text-slate-700 dark:text-slate-300">
{`const owners = await db
  .query("connections")
  .withIndex("to_type", q =>
    q.eq("toThingId", contentId)
     .eq("relationshipType",
       "owns")
  )
  .collect();

const ownerThings =
  await Promise.all(
    owners.map(c =>
      db.get(c.fromThingId)
    )
  );`}
              </code>
            </div>

            <!-- Pattern 3 -->
            <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">Course progress?</h3>
              <code class="text-xs font-mono text-slate-700 dark:text-slate-300">
{`const enrollment =
  await db
    .query("connections")
    .withIndex("from_type", q =>
      q.eq("fromThingId", userId)
       .eq("relationshipType",
         "enrolled_in")
    )
    .first();

if (enrollment) {
  const progress =
    enrollment.metadata
      ?.progress || 0;
  const course =
    await db.get(
      enrollment.toThingId
    );
}`}
              </code>
            </div>
          </div>
        </CardContent>
      </Card>

      <!-- Protocol-Agnostic Design -->
      < Card className="mb-16 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
        <CardHeader>
          <CardTitle>Protocol-Agnostic Design</CardTitle>
        </CardHeader>
        < CardContent className=" class="space-y-6">
          <p class="text-slate-700 dark:text-slate-300">
            Store protocol identity in metadata.protocol to support any integration.
          </p>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">A2A Protocol</h3>
              <code class="text-xs font-mono text-slate-700 dark:text-slate-300">
{`metadata: {
  protocol: "a2a",
  messageType:
    "task_delegation",
  task: "research",
  priority: "high"
}`}
              </code>
            </div>

            <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">ACP Protocol</h3>
              <code class="text-xs font-mono text-slate-700 dark:text-slate-300">
{`metadata: {
  protocol: "acp",
  eventType:
    "purchase_initiated",
  agentPlatform: "chatgpt",
  confirmationRequired: true
}`}
              </code>
            </div>

            <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">AP2 Protocol</h3>
              <code class="text-xs font-mono text-slate-700 dark:text-slate-300">
{`metadata: {
  protocol: "ap2",
  mandateType: "intent",
  autoExecute: true,
  conditions: ["verified"]
}`}
              </code>
            </div>

            <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-4">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-3">X402 Protocol</h3>
              <code class="text-xs font-mono text-slate-700 dark:text-slate-300">
{`metadata: {
  protocol: "x402",
  network: "base",
  txHash: "0x...",
  amount: "1000000000"
}`}
              </code>
            </div>
          </div>

          <div class="bg-indigo-50 dark:bg-indigo-950 border border-indigo-200 dark:border-indigo-800 rounded-lg p-4">
            <p class="text-sm text-indigo-900 dark:text-indigo-300">
              <span class="font-semibold">Key insight:</span> Every consolidated relationship type (transacted, communicated, delegated) can handle any protocol by storing protocol identity in metadata.
            </p>
          </div>
        </CardContent>
      </Card>

      <!-- Key Principles -->
      < Card className="mb-16 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-950 dark:to-blue-900 border-blue-200 dark:border-blue-800 shadow-lg">
        <CardHeader>
          < CardTitle className="text-slate-900 dark:text-white">Key Principles</CardTitle>
        </CardHeader>
        <CardContent>
          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-2">
              <div class="flex items-start gap-3">
                < LinkIcon className="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                <div>
                  <h3 class="font-semibold text-slate-900 dark:text-white">Thing-to-Thing</h3>
                  <p class="text-sm text-slate-700 dark:text-slate-300">Every connection links two things</p>
                </div>
              </div>
              <div class="flex items-start gap-3">
                < Database className="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                <div>
                  <h3 class="font-semibold text-slate-900 dark:text-white">Metadata for Variants</h3>
                  <p class="text-sm text-slate-700 dark:text-slate-300">Use metadata for relationship-specific data</p>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <Boxes class="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                <div>
                  <h3 class="font-semibold text-slate-900 dark:text-white">Bidirectional Indexes</h3>
                  <p class="text-sm text-slate-700 dark:text-slate-300">Efficient queries in both directions</p>
                </div>
              </div>
            </div>
            <div class="space-y-2">
              <div class="flex items-start gap-3">
                < Network className="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                <div>
                  <h3 class="font-semibold text-slate-900 dark:text-white">Protocol-Agnostic</h3>
                  <p class="text-sm text-slate-700 dark:text-slate-300">Protocol identity in metadata.protocol</p>
                </div>
              </div>
              <div class="flex items-start gap-3">
                < Zap className="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                <div>
                  <h3 class="font-semibold text-slate-900 dark:text-white">Flexible Schema</h3>
                  <p class="text-sm text-slate-700 dark:text-slate-300">metadata allows extension without schema changes</p>
                </div>
              </div>
              <div class="flex items-start gap-3">
                < Activity className="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                <div>
                  <h3 class="font-semibold text-slate-900 dark:text-white">Event-Driven</h3>
                  <p class="text-sm text-slate-700 dark:text-slate-300">Connection changes log events for audit trails</p>
                </div>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      <!-- React Hooks Examples -->
      < Card className="mb-16 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
        <CardHeader>
          <div class="flex items-center gap-2">
            < Code2 className="w-6 h-6 text-purple-600 dark:text-purple-400" />
            <CardTitle>React Hook Examples</CardTitle>
          </div>
        </CardHeader>
        < CardContent className=" class="space-y-6">
          <div>
            <h4 class="font-semibold text-slate-900 dark:text-white mb-3">List connections from an entity</h4>
            <div class="bg-slate-900 rounded p-4 overflow-x-auto">
              <pre class="text-sm text-slate-200"><code>{`import { useQuery } from 'convex/react';
import { api } from '@/convex/_generated/api';

export function EntityConnections({ entityId }: { entityId: Id<'entities'> }) {
  const connections = useQuery(api.connections.listFrom, {
    fromEntityId: entityId,
    relationshipType: 'owns'
  });

  if (connections === undefined) return <div>Loading...</div>;

  return (
    <div class="space-y-2">
      {connections.map(conn => (
        <div class="p-4 border rounded">
          <p class="font-semibold">{conn.relationshipType}</p>
          {conn.metadata && (
            <p class="text-sm text-slate-600">
              Balance: {conn.metadata.balance}
            </p>
          )}
        </div>
      ))}
    </div>
  );
}`}</code></pre>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-slate-900 dark:text-white mb-3">Filter by relationship type</h4>
            <div class="bg-slate-900 rounded p-4 overflow-x-auto">
              <pre class="text-sm text-slate-200"><code>{`export function TokenHolders({ tokenId }: { tokenId: Id<'entities'> }) {
  const holders = useQuery(api.connections.listTo, {
    toEntityId: tokenId,
    relationshipType: 'holds_tokens'
  });

  if (!holders) return null;

  return (
    <div>
      <h3>Token Holders</h3>
      {holders.map(conn => (
        <div>
          <span>{conn.fromThing?.name}</span>
          {conn.metadata?.balance && (
            <span class="ml-2">
              {conn.metadata.balance} tokens
            </span>
          )}
        </div>
      ))}
    </div>
  );
}`}</code></pre>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-slate-900 dark:text-white mb-3">Create a connection with metadata</h4>
            <div class="bg-slate-900 rounded p-4 overflow-x-auto">
              <pre class="text-sm text-slate-200"><code>{`export function EnrollButton({ courseId, userId }: Props) {
  const enrollStudent = useMutation(api.connections.create);

  const handleEnroll = async () => {
    await enrollStudent({
      fromEntityId: userId,
      toEntityId: courseId,
      relationshipType: 'enrolled_in',
      metadata: {
        progress: 0,
        enrolledAt: Date.now(),
        status: 'active'
      },
      strength: 0.5
    });
  };

  return (
    <button onClick={handleEnroll} class="btn-primary">
      Enroll in Course
    </button>
  );
}`}</code></pre>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-slate-900 dark:text-white mb-3">Find bidirectional connections</h4>
            <div class="bg-slate-900 rounded p-4 overflow-x-auto">
              <pre class="text-sm text-slate-200"><code>{`export function CollaborationDetails({
  personA,
  personB
}: {
  personA: Id<'entities'>,
  personB: Id<'entities'>
}) {
  const collaboration = useQuery(
    api.connections.listBetween,
    {
      fromEntityId: personA,
      toEntityId: personB,
      relationshipType: 'collaborates_with'
    }
  );

  if (!collaboration?.[0]) {
    return <p>No collaboration found</p>;
  }

  const conn = collaboration[0];

  return (
    <div>
      <p>Status: {conn.metadata?.status}</p>
      <p>Duration: {conn.metadata?.duration} months</p>
      <p>Projects: {conn.metadata?.projectCount}</p>
    </div>
  );
}`}</code></pre>
            </div>
          </div>
        </CardContent>
      </Card>

      <!-- Interactive Playground -->
      <div class="mb-16 bg-white dark:bg-slate-800 rounded-lg shadow-lg overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4">
          <h2 class="text-2xl font-bold text-white flex items-center gap-2">
            < Zap className="w-6 h-6" />
            Interactive Playground
          </h2>
          <p class="text-blue-100 text-sm mt-1">
            Explore real connection data with filters, search, and details view
          </p>
        </div>
        <div class="p-6">
          <ConnectionsDemo
            client:load
            connections={demoConnections}
            isLoading={false}
          />
          {error && (
            <div class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
              <p class="text-yellow-800 dark:text-yellow-300 text-sm">
                <span class="font-semibold">Running in Standalone Mode:</span> {error}. Demo data will show when connected to backend.
              </p>
            </div>
          )}
        </div>
      </div>

      <!-- Next Steps -->
      <div class="grid md:grid-cols-2 gap-8 mb-16">
        <a href="/demo/events" class="group">
          < Card className="bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg hover:shadow-xl transition h-full">
            <CardHeader>
              < CardTitle className="flex items-center gap-2 group-hover:text-blue-600 dark:group-hover:text-blue-400">
                Next: Events
                < ArrowRight className="w-4 h-4 group-hover:translate-x-1 transition" />
              </CardTitle>
              <CardDescription>Learn about actions and state changes over time</CardDescription>
            </CardHeader>
            <CardContent>
              <p class="text-sm text-slate-600 dark:text-slate-400">
                Explore the Events dimension to understand how all actions (purchases, creations, completions) are logged with complete audit trails.
              </p>
            </CardContent>
          </Card>
        </a>

        <a href="/demo" class="group">
          < Card className="bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg hover:shadow-xl transition h-full">
            <CardHeader>
              < CardTitle className="flex items-center gap-2 group-hover:text-blue-600 dark:group-hover:text-blue-400">
                Back to Overview
                < ArrowRight className="w-4 h-4 group-hover:translate-x-1 transition" />
              </CardTitle>
              <CardDescription>Explore all 6 dimensions</CardDescription>
            </CardHeader>
            <CardContent>
              <p class="text-sm text-slate-600 dark:text-slate-400">
                Return to the main demo to explore all dimensions: Groups, People, Things, Connections, Events, and Knowledge.
              </p>
            </CardContent>
          </Card>
        </a>
      </div>

      <!-- Features Summary -->
      <div class="grid md:grid-cols-3 gap-6">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6 border-l-4 border-blue-600 dark:border-blue-400">
          <div class="flex items-center gap-2 mb-3">
            < BarChart3 className="w-5 h-5 text-blue-600 dark:text-blue-400" />
            <h3 class="font-bold text-slate-900 dark:text-white">25+ Types</h3>
          </div>
          <p class="text-sm text-slate-600 dark:text-slate-400">
            Ownership, AI, content, community, business, tokens, and products relationships
          </p>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6 border-l-4 border-purple-600 dark:border-purple-400">
          <div class="flex items-center gap-2 mb-3">
            < RefreshCw className="w-5 h-5 text-purple-600 dark:text-purple-400" />
            <h3 class="font-bold text-slate-900 dark:text-white">Bidirectional Queries</h3>
          </div>
          <p class="text-sm text-slate-600 dark:text-slate-400">
            Efficiently query relationships from either direction with indexed lookups
          </p>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6 border-l-4 border-green-600 dark:border-green-400">
          <div class="flex items-center gap-2 mb-3">
            < Database className="w-5 h-5 text-green-600 dark:text-green-400" />
            <h3 class="font-bold text-slate-900 dark:text-white">Flexible Metadata</h3>
          </div>
          <p class="text-sm text-slate-600 dark:text-slate-400">
            Store relationship-specific data, temporal validity, and protocol details
          </p>
        </div>
      </div>

    </div>
  </main>
</Layout>
