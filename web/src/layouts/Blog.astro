---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import { ChevronRight, FolderOpen, Home } from "lucide-react";
import { ShareButtons } from "@/components/ShareButtons";
import Layout from "./Layout.astro";

type BlogEntry = CollectionEntry<"blog">;

interface Props {
	entry: BlogEntry;
	headings: { depth: number; slug: string; text: string }[];
	children: any;
}

const { entry, headings } = Astro.props as Props;

// Determine if this is a news article or blog post based on URL
const isNews = Astro.url.pathname.includes("/news/");

// Get all posts from the appropriate collection sorted by date to find previous/next
const allPosts = (await getCollection(isNews ? "news" : "blog"))
	.filter(
		(post: any) => post.data && (post.data.title || post.data.description),
	)
	.sort((a: any, b: any) => {
		const dateA = new Date(a.data.date).getTime();
		const dateB = new Date(b.data.date).getTime();
		return dateB - dateA; // Newest first
	});

// Find current post index
const currentIndex = allPosts.findIndex((post) => post.slug === entry.slug);
const previousPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
const nextPost =
	currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;

const pageData = {
	title: entry.data.title,
	description: entry.data.description,
	image: entry.data.picture || entry.data.image,
	type: "article",
};

// Construct full URL for sharing
const currentUrl = new URL(Astro.url.pathname, Astro.site).href;

// Format date
function formatDate(date: Date) {
	return new Intl.DateTimeFormat("en-US", {
		year: "numeric",
		month: "long",
		day: "numeric",
	}).format(date);
}

const mainContentClass =
	"prose dark:prose-invert max-w-none mx-auto prose-lg prose-headings:font-normal prose-p:text-gray-600 dark:prose-p:text-gray-300 prose-p:leading-relaxed prose-headings:text-gray-900 dark:prose-headings:text-gray-100 prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-img:rounded-lg prose-blockquote:border-l-4 prose-blockquote:border-gray-300 dark:prose-blockquote:border-gray-700 prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:text-gray-700 dark:prose-blockquote:text-gray-300 prose-blockquote:my-8";

// Set breadcrumb labels based on collection type
const breadcrumbLabel = isNews ? "News" : "Blog";
const breadcrumbHref = isNews ? "/news" : "/blog";
---

<Layout {...pageData}>
  <!-- Breadcrumbs -->
  <div class="w-full border-b pb-5">
    <nav class="flex items-center gap-2 text-sm text-muted-foreground p-0">
      {/* This aligns with the sidebar toggle button */}
      <a href="/" class="hover:text-foreground transition-colors flex items-center gap-1">
        <Home className="w-4 h-4" />
      </a>
      <ChevronRight className="w-4 h-4" />
      <a href={breadcrumbHref} class="hover:text-foreground transition-colors flex items-center gap-1">
        <FolderOpen className="w-4 h-4" />
        <span>{breadcrumbLabel}</span>
      </a>
      <ChevronRight className="w-4 h-4" />
      <span class="text-foreground font-medium truncate">{entry.data.title}</span>
    </nav>
  </div>

  <!-- Title and Date Section -->
  <div class="w-full px-4 sm:px-6 lg:px-8">
    <div class="mx-auto" style="max-width: 850px;">
      <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-foreground leading-tight mb-3">
        {entry.data.title}
      </h1>
      <div class="flex flex-wrap items-center gap-4 mb-8 text-sm text-muted-foreground">
        <span>{formatDate(new Date(entry.data.date))}</span>
        {entry.data.author && <span>By {entry.data.author}</span>}
        {entry.data.category && <span class="inline-block px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-medium">{entry.data.category}</span>}
      </div>
    </div>
  </div>

  <!-- Hero Image -->
  {
    (entry.data.picture || entry.data.image) && (entry.data.picture || entry.data.image).trim() !== '' && (
      <div class="w-full mb-8">
        <div class="mx-auto px-4 sm:px-6 lg:px-8" style="max-width: 850px;">
          <Image
            src={entry.data.picture || entry.data.image}
            alt={entry.data.title}
            width={1920}
            height={1080}
            quality={90}
            class="w-full rounded-lg"
          />
        </div>
      </div>
    )
  }

  <!-- Main Content -->
  <div class="w-full px-4 sm:px-6 lg:px-8 pb-12">
    <div class="mx-auto" style="max-width: 850px;">

      <!-- Article Content -->
      <article class={mainContentClass}>
        <slot />
      </article>

      <!-- Share Buttons -->
      <div class="mt-12">
        <ShareButtons client:load title={entry.data.title} url={currentUrl} />
      </div>

      <!-- Previous/Next Navigation -->
      <nav class="mt-16 flex justify-between items-center">
        <div class="flex-1">
          {
            previousPost && (
              <a
                href={`${breadcrumbHref}/${previousPost.slug}`}
                class="group flex items-center text-lg text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 mr-2 group-hover:-translate-x-1 transition-transform"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span class="line-clamp-1">{previousPost.data.title}</span>
              </a>
            )
          }
        </div>
        <div class="flex-1 text-right">
          {
            nextPost && (
              <a
                href={`${breadcrumbHref}/${nextPost.slug}`}
                class="group flex items-center justify-end text-lg text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors"
              >
                <span class="line-clamp-1">{nextPost.data.title}</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 ml-2 group-hover:translate-x-1 transition-transform"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
              </a>
            )
          }
        </div>
      </nav>
    </div>
  </div>

  <script>
    // Hide broken images gracefully
    document.addEventListener('DOMContentLoaded', () => {
      const contentImages = document.querySelectorAll('.prose img');
      contentImages.forEach((img) => {
        img.addEventListener('error', () => {
          (img as HTMLElement).style.display = 'none';
        });
      });
    });
  </script>
</Layout>
